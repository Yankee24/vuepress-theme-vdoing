<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《从0学习Flink源码》——Window | 从零学习大数据</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.e5addeae.css" as="style"><link rel="preload" href="/assets/js/app.69860091.js" as="script"><link rel="preload" href="/assets/js/2.5a5d1011.js" as="script"><link rel="preload" href="/assets/js/255.c420fc14.js" as="script"><link rel="prefetch" href="/assets/js/10.923ff8fe.js"><link rel="prefetch" href="/assets/js/100.f16aede8.js"><link rel="prefetch" href="/assets/js/101.16b3943d.js"><link rel="prefetch" href="/assets/js/102.1b982033.js"><link rel="prefetch" href="/assets/js/103.0edcb49a.js"><link rel="prefetch" href="/assets/js/104.93fd3934.js"><link rel="prefetch" href="/assets/js/105.7b351476.js"><link rel="prefetch" href="/assets/js/106.05c3afe2.js"><link rel="prefetch" href="/assets/js/107.17f5d621.js"><link rel="prefetch" href="/assets/js/108.6b0b469a.js"><link rel="prefetch" href="/assets/js/109.5fe5c7fd.js"><link rel="prefetch" href="/assets/js/11.5a5e6faf.js"><link rel="prefetch" href="/assets/js/110.8c2e1ad0.js"><link rel="prefetch" href="/assets/js/111.e7f443a4.js"><link rel="prefetch" href="/assets/js/112.3cc06ecb.js"><link rel="prefetch" href="/assets/js/113.0fd65e42.js"><link rel="prefetch" href="/assets/js/114.f40f9e82.js"><link rel="prefetch" href="/assets/js/115.db5479c4.js"><link rel="prefetch" href="/assets/js/116.584588db.js"><link rel="prefetch" href="/assets/js/117.0389dc01.js"><link rel="prefetch" href="/assets/js/118.20eb6ebf.js"><link rel="prefetch" href="/assets/js/119.aaaa830d.js"><link rel="prefetch" href="/assets/js/12.5bcae2a5.js"><link rel="prefetch" href="/assets/js/120.96fe3cc8.js"><link rel="prefetch" href="/assets/js/121.c12e5733.js"><link rel="prefetch" href="/assets/js/122.0b114237.js"><link rel="prefetch" href="/assets/js/123.85896876.js"><link rel="prefetch" href="/assets/js/124.d4ce4448.js"><link rel="prefetch" href="/assets/js/125.a07e629d.js"><link rel="prefetch" href="/assets/js/126.e82bc271.js"><link rel="prefetch" href="/assets/js/127.b966dc51.js"><link rel="prefetch" href="/assets/js/128.f5318311.js"><link rel="prefetch" href="/assets/js/129.033da70b.js"><link rel="prefetch" href="/assets/js/13.b0e48d3c.js"><link rel="prefetch" href="/assets/js/130.6e51a8a3.js"><link rel="prefetch" href="/assets/js/131.a9eac853.js"><link rel="prefetch" href="/assets/js/132.51cc0fe9.js"><link rel="prefetch" href="/assets/js/133.7c4e5fa5.js"><link rel="prefetch" href="/assets/js/134.0d4649d4.js"><link rel="prefetch" href="/assets/js/135.2795b689.js"><link rel="prefetch" href="/assets/js/136.6d810189.js"><link rel="prefetch" href="/assets/js/137.5efba685.js"><link rel="prefetch" href="/assets/js/138.e6ffeb9b.js"><link rel="prefetch" href="/assets/js/139.0f6209a7.js"><link rel="prefetch" href="/assets/js/14.aa487061.js"><link rel="prefetch" href="/assets/js/140.d608dfc1.js"><link rel="prefetch" href="/assets/js/141.260a5e10.js"><link rel="prefetch" href="/assets/js/142.a1bf6834.js"><link rel="prefetch" href="/assets/js/143.e8504b72.js"><link rel="prefetch" href="/assets/js/144.473e503a.js"><link rel="prefetch" href="/assets/js/145.05597eba.js"><link rel="prefetch" href="/assets/js/146.720763ca.js"><link rel="prefetch" href="/assets/js/147.4f8213bf.js"><link rel="prefetch" href="/assets/js/148.822505fd.js"><link rel="prefetch" href="/assets/js/149.0012118f.js"><link rel="prefetch" href="/assets/js/15.9daa4aeb.js"><link rel="prefetch" href="/assets/js/150.8fc18c42.js"><link rel="prefetch" href="/assets/js/151.5fafe6cd.js"><link rel="prefetch" href="/assets/js/152.30d29af5.js"><link rel="prefetch" href="/assets/js/153.24749e28.js"><link rel="prefetch" href="/assets/js/154.f6e6152a.js"><link rel="prefetch" href="/assets/js/155.d6998d0c.js"><link rel="prefetch" href="/assets/js/156.a0b198c0.js"><link rel="prefetch" href="/assets/js/157.a4168bf4.js"><link rel="prefetch" href="/assets/js/158.df0a8e57.js"><link rel="prefetch" href="/assets/js/159.9c922bc7.js"><link rel="prefetch" href="/assets/js/16.181cffa1.js"><link rel="prefetch" href="/assets/js/160.b0dfe382.js"><link rel="prefetch" href="/assets/js/161.74b287eb.js"><link rel="prefetch" href="/assets/js/162.e53e48f5.js"><link rel="prefetch" href="/assets/js/163.858bdc76.js"><link rel="prefetch" href="/assets/js/164.db9e00ed.js"><link rel="prefetch" href="/assets/js/165.7665ebd3.js"><link rel="prefetch" href="/assets/js/166.bdec7786.js"><link rel="prefetch" href="/assets/js/167.943c7fac.js"><link rel="prefetch" href="/assets/js/168.82b92810.js"><link rel="prefetch" href="/assets/js/169.79bbcbe7.js"><link rel="prefetch" href="/assets/js/17.aed045e3.js"><link rel="prefetch" href="/assets/js/170.3c6a8856.js"><link rel="prefetch" href="/assets/js/171.7b446bf8.js"><link rel="prefetch" href="/assets/js/172.9b4f968c.js"><link rel="prefetch" href="/assets/js/173.fbc1675b.js"><link rel="prefetch" href="/assets/js/174.73be5b8d.js"><link rel="prefetch" href="/assets/js/175.249c730a.js"><link rel="prefetch" href="/assets/js/176.bdcc8567.js"><link rel="prefetch" href="/assets/js/177.670af4ec.js"><link rel="prefetch" href="/assets/js/178.8f4a08d1.js"><link rel="prefetch" href="/assets/js/179.79ede7b6.js"><link rel="prefetch" href="/assets/js/18.5d983a22.js"><link rel="prefetch" href="/assets/js/180.bf9b14b2.js"><link rel="prefetch" href="/assets/js/181.af12bc7e.js"><link rel="prefetch" href="/assets/js/182.c209db51.js"><link rel="prefetch" href="/assets/js/183.b4865945.js"><link rel="prefetch" href="/assets/js/184.7e08d8a2.js"><link rel="prefetch" href="/assets/js/185.89540961.js"><link rel="prefetch" href="/assets/js/186.bf93d0cf.js"><link rel="prefetch" href="/assets/js/187.c7ab2562.js"><link rel="prefetch" href="/assets/js/188.65098466.js"><link rel="prefetch" href="/assets/js/189.6435b2ab.js"><link rel="prefetch" href="/assets/js/19.1f9fbdc9.js"><link rel="prefetch" href="/assets/js/190.7b09958a.js"><link rel="prefetch" href="/assets/js/191.2cf71180.js"><link rel="prefetch" href="/assets/js/192.8d9704a7.js"><link rel="prefetch" href="/assets/js/193.bf6325b9.js"><link rel="prefetch" href="/assets/js/194.4f0fafd1.js"><link rel="prefetch" href="/assets/js/195.246863ac.js"><link rel="prefetch" href="/assets/js/196.f608f32b.js"><link rel="prefetch" href="/assets/js/197.f6cc8f50.js"><link rel="prefetch" href="/assets/js/198.a5578d26.js"><link rel="prefetch" href="/assets/js/199.11890423.js"><link rel="prefetch" href="/assets/js/20.4cb88e4b.js"><link rel="prefetch" href="/assets/js/200.c9f8e946.js"><link rel="prefetch" href="/assets/js/201.ce037fc7.js"><link rel="prefetch" href="/assets/js/202.ef0539ce.js"><link rel="prefetch" href="/assets/js/203.988c68d9.js"><link rel="prefetch" href="/assets/js/204.6c137aab.js"><link rel="prefetch" href="/assets/js/205.9036bb65.js"><link rel="prefetch" href="/assets/js/206.c580525c.js"><link rel="prefetch" href="/assets/js/207.7c41326a.js"><link rel="prefetch" href="/assets/js/208.1607d918.js"><link rel="prefetch" href="/assets/js/209.9259989c.js"><link rel="prefetch" href="/assets/js/21.80ec6f40.js"><link rel="prefetch" href="/assets/js/210.d50db2ef.js"><link rel="prefetch" href="/assets/js/211.bc2685b0.js"><link rel="prefetch" href="/assets/js/212.efea3cf2.js"><link rel="prefetch" href="/assets/js/213.bce9f926.js"><link rel="prefetch" href="/assets/js/214.904b4497.js"><link rel="prefetch" href="/assets/js/215.6aefea59.js"><link rel="prefetch" href="/assets/js/216.e031d3bd.js"><link rel="prefetch" href="/assets/js/217.e6326d37.js"><link rel="prefetch" href="/assets/js/218.9aed6d93.js"><link rel="prefetch" href="/assets/js/219.9e16adc0.js"><link rel="prefetch" href="/assets/js/22.05fa6204.js"><link rel="prefetch" href="/assets/js/220.b214d6d8.js"><link rel="prefetch" href="/assets/js/221.bc937a8c.js"><link rel="prefetch" href="/assets/js/222.a113a4fb.js"><link rel="prefetch" href="/assets/js/223.385290e7.js"><link rel="prefetch" href="/assets/js/224.8130ac54.js"><link rel="prefetch" href="/assets/js/225.f39ff910.js"><link rel="prefetch" href="/assets/js/226.099d1901.js"><link rel="prefetch" href="/assets/js/227.e1f6b467.js"><link rel="prefetch" href="/assets/js/228.d82f8db3.js"><link rel="prefetch" href="/assets/js/229.eda913c0.js"><link rel="prefetch" href="/assets/js/23.33289b0e.js"><link rel="prefetch" href="/assets/js/230.a4020d42.js"><link rel="prefetch" href="/assets/js/231.f37f1b59.js"><link rel="prefetch" href="/assets/js/232.6f2c9e2d.js"><link rel="prefetch" href="/assets/js/233.90b6ca00.js"><link rel="prefetch" href="/assets/js/234.aa025266.js"><link rel="prefetch" href="/assets/js/235.89829e8d.js"><link rel="prefetch" href="/assets/js/236.0de24334.js"><link rel="prefetch" href="/assets/js/237.ca10ac0d.js"><link rel="prefetch" href="/assets/js/238.bc0b2f20.js"><link rel="prefetch" href="/assets/js/239.b7361c91.js"><link rel="prefetch" href="/assets/js/24.222b2e5a.js"><link rel="prefetch" href="/assets/js/240.7fdb9c15.js"><link rel="prefetch" href="/assets/js/241.439455de.js"><link rel="prefetch" href="/assets/js/242.3a285408.js"><link rel="prefetch" href="/assets/js/243.9060c910.js"><link rel="prefetch" href="/assets/js/244.65c17482.js"><link rel="prefetch" href="/assets/js/245.655b77db.js"><link rel="prefetch" href="/assets/js/246.de53591d.js"><link rel="prefetch" href="/assets/js/247.a1411e89.js"><link rel="prefetch" href="/assets/js/248.f2b6d619.js"><link rel="prefetch" href="/assets/js/249.40cc2013.js"><link rel="prefetch" href="/assets/js/25.fd519c59.js"><link rel="prefetch" href="/assets/js/250.d18d274b.js"><link rel="prefetch" href="/assets/js/251.221ffd29.js"><link rel="prefetch" href="/assets/js/252.749deb12.js"><link rel="prefetch" href="/assets/js/253.cb462023.js"><link rel="prefetch" href="/assets/js/254.8b979b0e.js"><link rel="prefetch" href="/assets/js/256.cc875ff8.js"><link rel="prefetch" href="/assets/js/257.80c6d2c7.js"><link rel="prefetch" href="/assets/js/258.039d78aa.js"><link rel="prefetch" href="/assets/js/259.45822a82.js"><link rel="prefetch" href="/assets/js/26.c77d9f44.js"><link rel="prefetch" href="/assets/js/260.9606e8ea.js"><link rel="prefetch" href="/assets/js/261.5bb91bcb.js"><link rel="prefetch" href="/assets/js/262.c14ea476.js"><link rel="prefetch" href="/assets/js/263.4d300af5.js"><link rel="prefetch" href="/assets/js/264.4965d6cd.js"><link rel="prefetch" href="/assets/js/265.3ab3d8df.js"><link rel="prefetch" href="/assets/js/266.a356cba1.js"><link rel="prefetch" href="/assets/js/267.a8c17038.js"><link rel="prefetch" href="/assets/js/268.404d0f59.js"><link rel="prefetch" href="/assets/js/269.d6c5b967.js"><link rel="prefetch" href="/assets/js/27.2d4e462d.js"><link rel="prefetch" href="/assets/js/270.ee054be0.js"><link rel="prefetch" href="/assets/js/271.0d024575.js"><link rel="prefetch" href="/assets/js/272.0a220788.js"><link rel="prefetch" href="/assets/js/273.f0094be8.js"><link rel="prefetch" href="/assets/js/274.96185f67.js"><link rel="prefetch" href="/assets/js/275.01716e6c.js"><link rel="prefetch" href="/assets/js/276.52d955a8.js"><link rel="prefetch" href="/assets/js/277.16592fb3.js"><link rel="prefetch" href="/assets/js/278.f37681fd.js"><link rel="prefetch" href="/assets/js/28.2d9f6816.js"><link rel="prefetch" href="/assets/js/29.22ed0fbf.js"><link rel="prefetch" href="/assets/js/3.b5505cb0.js"><link rel="prefetch" href="/assets/js/30.ab67dc1f.js"><link rel="prefetch" href="/assets/js/31.2b540d9e.js"><link rel="prefetch" href="/assets/js/32.1522eb16.js"><link rel="prefetch" href="/assets/js/33.f65f5043.js"><link rel="prefetch" href="/assets/js/34.80cc3f17.js"><link rel="prefetch" href="/assets/js/35.fa8dfa7e.js"><link rel="prefetch" href="/assets/js/36.7120533b.js"><link rel="prefetch" href="/assets/js/37.c5a78bc9.js"><link rel="prefetch" href="/assets/js/38.69c7afa0.js"><link rel="prefetch" href="/assets/js/39.0eef158e.js"><link rel="prefetch" href="/assets/js/4.ff141686.js"><link rel="prefetch" href="/assets/js/40.35c52f34.js"><link rel="prefetch" href="/assets/js/41.26d8c534.js"><link rel="prefetch" href="/assets/js/42.8bc84b00.js"><link rel="prefetch" href="/assets/js/43.d8065eba.js"><link rel="prefetch" href="/assets/js/44.b19c19b0.js"><link rel="prefetch" href="/assets/js/45.8d5a2abd.js"><link rel="prefetch" href="/assets/js/46.47f5b7a1.js"><link rel="prefetch" href="/assets/js/47.10f3e4e0.js"><link rel="prefetch" href="/assets/js/48.987bbb14.js"><link rel="prefetch" href="/assets/js/49.294ccf05.js"><link rel="prefetch" href="/assets/js/5.804a9c7d.js"><link rel="prefetch" href="/assets/js/50.95d99a21.js"><link rel="prefetch" href="/assets/js/51.f9b2e205.js"><link rel="prefetch" href="/assets/js/52.0762648d.js"><link rel="prefetch" href="/assets/js/53.abd32869.js"><link rel="prefetch" href="/assets/js/54.7441c3bb.js"><link rel="prefetch" href="/assets/js/55.4cefc5c5.js"><link rel="prefetch" href="/assets/js/56.f0a167f5.js"><link rel="prefetch" href="/assets/js/57.e7c2b85d.js"><link rel="prefetch" href="/assets/js/58.6efa9d32.js"><link rel="prefetch" href="/assets/js/59.d3b84ddf.js"><link rel="prefetch" href="/assets/js/6.9beabe83.js"><link rel="prefetch" href="/assets/js/60.17f54d49.js"><link rel="prefetch" href="/assets/js/61.3ec7fc02.js"><link rel="prefetch" href="/assets/js/62.d37f1c0c.js"><link rel="prefetch" href="/assets/js/63.42881792.js"><link rel="prefetch" href="/assets/js/64.11a6d2dd.js"><link rel="prefetch" href="/assets/js/65.bf703c16.js"><link rel="prefetch" href="/assets/js/66.ed5395d3.js"><link rel="prefetch" href="/assets/js/67.c1063689.js"><link rel="prefetch" href="/assets/js/68.c8485750.js"><link rel="prefetch" href="/assets/js/69.615e51f0.js"><link rel="prefetch" href="/assets/js/7.fec36169.js"><link rel="prefetch" href="/assets/js/70.a9ce79fc.js"><link rel="prefetch" href="/assets/js/71.e06041f7.js"><link rel="prefetch" href="/assets/js/72.43904462.js"><link rel="prefetch" href="/assets/js/73.c758fa40.js"><link rel="prefetch" href="/assets/js/74.5cfa12f4.js"><link rel="prefetch" href="/assets/js/75.ae5a3df9.js"><link rel="prefetch" href="/assets/js/76.30f68e44.js"><link rel="prefetch" href="/assets/js/77.47917316.js"><link rel="prefetch" href="/assets/js/78.eb1a0f14.js"><link rel="prefetch" href="/assets/js/79.44f29445.js"><link rel="prefetch" href="/assets/js/8.8d4140a1.js"><link rel="prefetch" href="/assets/js/80.15297bfe.js"><link rel="prefetch" href="/assets/js/81.0f68e8af.js"><link rel="prefetch" href="/assets/js/82.14d5a78a.js"><link rel="prefetch" href="/assets/js/83.499cba09.js"><link rel="prefetch" href="/assets/js/84.adfbad7c.js"><link rel="prefetch" href="/assets/js/85.2a7dc9f1.js"><link rel="prefetch" href="/assets/js/86.181c6b1f.js"><link rel="prefetch" href="/assets/js/87.e1b5f8f8.js"><link rel="prefetch" href="/assets/js/88.e48ff88a.js"><link rel="prefetch" href="/assets/js/89.3c55b2a2.js"><link rel="prefetch" href="/assets/js/9.02e0b20e.js"><link rel="prefetch" href="/assets/js/90.eb838c7c.js"><link rel="prefetch" href="/assets/js/91.f9de218b.js"><link rel="prefetch" href="/assets/js/92.1b34a23f.js"><link rel="prefetch" href="/assets/js/93.380e957c.js"><link rel="prefetch" href="/assets/js/94.feb95e99.js"><link rel="prefetch" href="/assets/js/95.6e722f95.js"><link rel="prefetch" href="/assets/js/96.8e625826.js"><link rel="prefetch" href="/assets/js/97.ae5a2075.js"><link rel="prefetch" href="/assets/js/98.716f5b6e.js"><link rel="prefetch" href="/assets/js/99.e0384484.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e5addeae.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="从零学习大数据" class="logo"> <span class="site-name can-hide">从零学习大数据</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/frame/" class="nav-link">大数据框架</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Yanko24" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="img/logo.jpg"> <div class="blogger-info"><h3>Yanko</h3> <span>一个大数据行业的菜鸟</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/frame/" class="nav-link">大数据框架</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Yanko24" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flink基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flink进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Flink源码</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/46833d/" class="sidebar-link">《从0学习Flink源码》——Flink源码编译及部署</a></li><li><a href="/pages/3f76c3/" class="sidebar-link">《从0学习Flink源码》——构建源码测试环境</a></li><li><a href="/pages/271d4f/" class="sidebar-link">《从0学习Flink源码》——Flink集群启动流程</a></li><li><a href="/pages/128d25/" class="sidebar-link">《从0学习Flink源码》——JobManager启动过程</a></li><li><a href="/pages/be504e/" class="sidebar-link">《从0学习Flink源码》——TaskManager启动流程</a></li><li><a href="/pages/c5dabf/" class="sidebar-link">《从0学习Flink源码》——State</a></li><li><a href="/pages/06b4da/" aria-current="page" class="active sidebar-link">《从0学习Flink源码》——Window</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/78d1d9/" class="sidebar-link">深入理解Java虚拟机</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flink面试题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=%E3%80%8A%E4%BB%8E%E9%9B%B6%E5%AD%A6%E4%B9%A0Flink%E3%80%8B" title="分类" data-v-1baff76c>《从零学习Flink》</a></li><li data-v-1baff76c><a href="/categories/?category=Flink%E6%BA%90%E7%A0%81" title="分类" data-v-1baff76c>Flink源码</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/Yanko24" target="_blank" title="作者" class="beLink" data-v-1baff76c>Yanko24</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-04-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">《从0学习Flink源码》——Window<!----></h1>  <div class="theme-vdoing-content content__default"><h4 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1. 前言</h4> <p>Flink四大基石之一的Window，同时也是Flink中处理无限流的核心，我们可以针对不同的时间语义等采用不同的Window窗口进行计算。接下来我们看看在Flink中Window具体是怎么实现的？在Window中的数据又是何时触发计算的？</p> <h4 id="_2-window的使用方法"><a href="#_2-window的使用方法" class="header-anchor">#</a> 2. Window的使用方法</h4> <h5 id="_1-keyed-windows"><a href="#_1-keyed-windows" class="header-anchor">#</a> 1. Keyed Windows</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code>stream
       .keyBy(...)               &lt;-  keyed versus non-keyed windows
       .window(...)              &lt;-  required: &quot;assigner&quot;
      [.trigger(...)]            &lt;-  optional: &quot;trigger&quot; (else default trigger)
      [.evictor(...)]            &lt;-  optional: &quot;evictor&quot; (else no evictor)
      [.allowedLateness(...)]    &lt;-  optional: &quot;lateness&quot; (else zero)
      [.sideOutputLateData(...)] &lt;-  optional: &quot;output tag&quot; (else no side output for late data)
       .reduce/aggregate/apply()      &lt;-  required: &quot;function&quot;
      [.getSideOutput(...)]      &lt;-  optional: &quot;output tag&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="_2-non-keyed-windows"><a href="#_2-non-keyed-windows" class="header-anchor">#</a> 2. Non-Keyed Windows</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code>stream
       .windowAll(...)           &lt;-  required: &quot;assigner&quot;
      [.trigger(...)]            &lt;-  optional: &quot;trigger&quot; (else default trigger)
      [.evictor(...)]            &lt;-  optional: &quot;evictor&quot; (else no evictor)
      [.allowedLateness(...)]    &lt;-  optional: &quot;lateness&quot; (else zero)
      [.sideOutputLateData(...)] &lt;-  optional: &quot;output tag&quot; (else no side output for late data)
       .reduce/aggregate/apply()      &lt;-  required: &quot;function&quot;
      [.getSideOutput(...)]      &lt;-  optional: &quot;output tag&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们重点关注Keyed Windows的具体实现，Non-Keyed Windows是基于Keyed Windows的一种特殊实现。</p> <p>Window的基本用法：在window中需要一个WindowAssigner将KeyedStream转换成WindowedStream，然后就可以指定窗口的计算逻辑，这块分为全量窗口计算(apply和process)和增量窗口计算(reduce和aggregate)，之后就是触发窗口计算的Trigger以及能够修改窗口内元素的Evictor，此时便会通过WindowOperatorBuilder生成一个WindowOperator，窗口的处理逻辑主要就在WindowOperator中。</p> <h4 id="_3-trigger和timer"><a href="#_3-trigger和timer" class="header-anchor">#</a> 3. Trigger和Timer</h4> <p>在看Window相关的代码实现之前，我们先看看触发器Trigger和定时器Timer，触发器Trigger在Window中有着不可替代的作用，因为Window其实就是进行划分元素属于那个窗口或那几个窗口，当元素进入窗口后何时进行计算，就是触发器Trigger和定时器Timer所负责的事情了。</p> <h5 id="_1-trigger"><a href="#_1-trigger" class="header-anchor">#</a> 1. Trigger</h5> <p><img src="http://yanko.test.upcdn.net/images/Trigger.png" alt=""></p> <p>Trigger是用来确定一个窗口是否应该触发结果的计算，Trigger提供了一系列的回调函数，根据回调函数返回的结果来决定是否应该触发窗口的计算。Trigger在Flink内置的几种实现包括：</p> <ul><li>EventTimeTrigger：所有事件时间窗口的默认触发器</li> <li>ProcessingTimeTrigger：所有处理时间窗口的默认触发器</li> <li>ContinuousEventTimeTrigger：按照事件时间定期进行触发</li> <li>ContinuousProcessingTimeTrigger：按照处理时间定期进行触发</li> <li>CountTrigger：按照窗口内元素个数进行触发</li> <li>DeltaTrigger：按照DeltaFunction进行触发</li> <li>NeverTrigger：永远不会触发</li> <li>PurgingTrigger：接受另一个Trigger，并将其转换成一个会清理数据的Trigger</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4104633972991191369L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Called for every element that gets added to a pane. The result of this will determine whether
     * the pane is evaluated to emit results.
     * 添加到窗口的每个元素都会调用该方法
     *
     * @param element The element that arrived.
     * @param timestamp The timestamp of the element that arrived.
     * @param window The window to which the element is being added.
     * @param ctx A context object that can be used to register timer callbacks.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">TriggerResult</span> <span class="token function">onElement</span><span class="token punctuation">(</span><span class="token class-name">T</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Called when a processing-time timer that was set using the trigger context fires.
     * 当注册的ProcessTime的定时器触发时调用该方法
     *
     * @param time The timestamp at which the timer fired.
     * @param window The window for which the timer fired.
     * @param ctx A context object that can be used to register timer callbacks.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">TriggerResult</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Called when an event-time timer that was set using the trigger context fires.
     * 当注册的EventTime的定时器触发时调用该方法
     *
     * @param time The timestamp at which the timer fired.
     * @param window The window for which the timer fired.
     * @param ctx A context object that can be used to register timer callbacks.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">TriggerResult</span> <span class="token function">onEventTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Returns true if this trigger supports merging of trigger state and can therefore be used with
     * a {@link org.apache.flink.streaming.api.windowing.assigners.MergingWindowAssigner}.
     * 判断该Trigger是否支持合并触发器状态，如果支持则返回true，否则返回false
     *
     * &lt;p&gt;If this returns {@code true} you must properly implement {@link #onMerge(Window,
     * OnMergeContext)}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Called when several windows have been merged into one window by the {@link
     * org.apache.flink.streaming.api.windowing.assigners.WindowAssigner}.
     * 与有状态触发器相关，并在两个触发器对应的窗口合并时合并它们的状态，例如在使用会话窗口时
     *
     * @param window The new window that results from the merge.
     * @param ctx A context object that can be used to register timer callbacks and access state.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMerge</span><span class="token punctuation">(</span><span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">OnMergeContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;This trigger does not support merging.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Clears any state that the trigger might still hold for the given window. This is called when
     * a window is purged. Timers set using {@link TriggerContext#registerEventTimeTimer(long)} and
     * {@link TriggerContext#registerProcessingTimeTimer(long)} should be deleted here as well as
     * state acquired using {@link TriggerContext#getPartitionedState(StateDescriptor)}.
     *
     * 执行删除相应窗口时所需的任何操作(一般是删除定义的状态、定时器等)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Extension of {@link TriggerContext} that is given to {@link Trigger#onMerge(Window,
     * OnMergeContext)}.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OnMergeContext</span> <span class="token keyword">extends</span> <span class="token class-name">TriggerContext</span> <span class="token punctuation">{</span>
        <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">MergingState</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">mergePartitionedState</span><span class="token punctuation">(</span>
                <span class="token class-name">StateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> stateDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><p>和Trigger类一起出现的还有TriggerResult这个枚举类，当Trigger触发调用起回调函数，回调函数的返回值被包装成了TriggerResult类，其中有四种类型，分别是触发计算FIRE、不对数据做任何处理CONTINUE、对窗口不做计算但是清除窗口中的数据PURAGE以及触发计算并清除窗口中的数据FIRE_AND_PURAGE，看看其具体的实现。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">TriggerResult</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * No action is taken on the window.
     * 对窗口不做任何处理
     */</span>
    <span class="token function">CONTINUE</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * {@code FIRE_AND_PURGE} evaluates the window function and emits the window result.
     * 对窗口进行计算，并清除窗口中的数据
     */</span>
    <span class="token function">FIRE_AND_PURGE</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * On {@code FIRE}, the window is evaluated and results are emitted. The window is not purged,
     * though, all elements are retained.
     * 对窗口进行计算，但不会清除数据
     */</span>
    <span class="token function">FIRE</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * All elements in the window are cleared and the window is discarded, without evaluating the
     * window function or emitting any elements.
     * 对窗口不做计算，但是会清除窗口中的数据
     */</span>
    <span class="token function">PURGE</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h5 id="_2-timer"><a href="#_2-timer" class="header-anchor">#</a> 2. Timer</h5> <p>Timer是用来实现定时触发器的功能，通过TimerServices注册timer，触发的回调函数被封装为Triggerable。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TimerService</span> <span class="token punctuation">{</span>
    <span class="token comment">/** Error string for {@link UnsupportedOperationException} on registering timers. */</span>
    <span class="token class-name">String</span> UNSUPPORTED_REGISTER_TIMER_MSG <span class="token operator">=</span> <span class="token string">&quot;Setting timers is only supported on a keyed streams.&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/** Error string for {@link UnsupportedOperationException} on deleting timers. */</span>
    <span class="token class-name">String</span> UNSUPPORTED_DELETE_TIMER_MSG <span class="token operator">=</span> <span class="token string">&quot;Deleting timers is only supported on a keyed streams.&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> <span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token function">currentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">registerProcessingTimeTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">deleteProcessingTimeTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/** Invoked when an event-time timer fires. */</span>
    <span class="token keyword">void</span> <span class="token function">onEventTime</span><span class="token punctuation">(</span><span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/** Invoked when a processing-time timer fires. */</span>
    <span class="token keyword">void</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>TimerService不仅仅提供了注册和删除定时器的方法，同时还提供了可以获取当前处理时间以及watermark的方法。需要注意，Timer只能在KeyedStream中使用。在Flink内部，和TimerService对应的是InternalTimerService，其对应的实现类有两个，分别是InternalTimerServiceImpl和BatchExecutionInternalTimerService两个，后者是使用在BATCH执行模式上的。InternalTimerService和TimerService还有一个区别是InternalTimerService可以设置其关联的namespace。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">PriorityComparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalTimer</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Keyed</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/** Function to extract the key from a {@link InternalTimer}. */</span>
    <span class="token class-name">KeyExtractorFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalTimer</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> KEY_EXTRACTOR_FUNCTION <span class="token operator">=</span> <span class="token class-name">InternalTimer</span><span class="token operator">::</span><span class="token function">getKey</span><span class="token punctuation">;</span>

    <span class="token comment">/** Function to compare instances of {@link InternalTimer}. */</span>
    <span class="token class-name">PriorityComparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalTimer</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> TIMER_COMPARATOR <span class="token operator">=</span>
            <span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> right<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Returns the timestamp of the timer. This value determines the point in time when the timer
     * will fire.
     */</span>
    <span class="token keyword">long</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** Returns the key that is bound to this timer. */</span>
    <span class="token annotation punctuation">@Nonnull</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token class-name">K</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** Returns the namespace that is bound to this timer. */</span>
    <span class="token annotation punctuation">@Nonnull</span>
    <span class="token class-name">N</span> <span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InternalTimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/** Processing time timers that are currently in-flight. */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KeyGroupedInternalPriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimerHeapInternalTimer</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
            processingTimeTimersQueue<span class="token punctuation">;</span>

    <span class="token comment">/** Event time timers that are currently in-flight. */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KeyGroupedInternalPriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimerHeapInternalTimer</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
            eventTimeTimersQueue<span class="token punctuation">;</span>

    <span class="token comment">/**
     * The local event time, as denoted by the last received {@link
     * org.apache.flink.streaming.api.watermark.Watermark Watermark}.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> currentWatermark <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> triggerTarget<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h6 id="_1-processtime"><a href="#_1-processtime" class="header-anchor">#</a> 1. ProcessTime</h6> <p>ProcessTime的定时器触发依赖于ProcessingTimeService，它负责所有基于处理时间语义的定时器的管理，内部使用ScheduledFuture进行调度定时任务，当任务被触发时，ProcessTime的回调函数ProcessingTimeCallback会被调用。实际上，InternalTimerServiceImpl依赖了ProcessingTimeService，并在其内部实现了ProcessingTimeCallback接口。当注册一个ProcessTime的定时器时，会将timer加入processingTimeTimersQueue优先级队列，并设置下一次ProcessingTimeService的触发时间，当ProcessingTimeService触发后，调用onProcessingTime方法，会从优先级队列中取出所有符合条件的定时器，调用triggerTarget.onProcessingTimr(timer)。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InternalTimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ProcessingTimeService</span> processingTimeService<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> nextTimer<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerProcessingTimeTimer</span><span class="token punctuation">(</span><span class="token class-name">N</span> namespace<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> oldHead <span class="token operator">=</span> processingTimeTimersQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>processingTimeTimersQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">TimerHeapInternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">K</span><span class="token punctuation">)</span> keyContext<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> nextTriggerTime <span class="token operator">=</span> oldHead <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> oldHead<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
            <span class="token comment">// check if we need to re-schedule our timer to earlier</span>
            <span class="token comment">// 如果新加入的timer触发时间早于下一次的触发时间，那么应该重新设置下一次的触发时间</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> nextTriggerTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextTimer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextTimer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 注册下一个timer</span>
                nextTimer <span class="token operator">=</span> processingTimeService<span class="token punctuation">.</span><span class="token function">registerTimer</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">onProcessingTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// null out the timer in case the Triggerable calls registerProcessingTimeTimer()</span>
        <span class="token comment">// inside the callback.</span>
        nextTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
        <span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">;</span>
    
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timer <span class="token operator">=</span> processingTimeTimersQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> timer<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            processingTimeTimersQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyContext<span class="token punctuation">.</span><span class="token function">setCurrentKey</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// timer所对应的triggerTarget.onProcessingTime被调用</span>
            triggerTarget<span class="token punctuation">.</span><span class="token function">onProcessingTime</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextTimer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 注册下一个timer</span>
            nextTimer <span class="token operator">=</span>
                    processingTimeService<span class="token punctuation">.</span><span class="token function">registerTimer</span><span class="token punctuation">(</span>
                            timer<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">onProcessingTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProcessingTimeService</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token function">getCurrentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">ProcessingTimeCallback</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
            <span class="token class-name">ProcessingTimeCallback</span> callback<span class="token punctuation">,</span> <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span> <span class="token keyword">long</span> period<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span>
            <span class="token class-name">ProcessingTimeCallback</span> callback<span class="token punctuation">,</span> <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span> <span class="token keyword">long</span> period<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">quiesce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProcessingTimeCallback</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h6 id="_2-eventtime"><a href="#_2-eventtime" class="header-anchor">#</a> 2. EventTime</h6> <p>EventTime的定时器触发是依赖于当前的watermark，当注册一个EventTime的定时器时，会将对应的timer写入eventTimeTimersQueue优先级队列中，当watermark上升时，advanceWatermark会被调用，这时会检查优先队列中时间早于当前watermark的timer，并依次调用triggerTarget.onEvnentTime(timer)。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InternalTimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span><span class="token class-name">N</span> namespace<span class="token punctuation">,</span> <span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventTimeTimersQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">TimerHeapInternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">K</span><span class="token punctuation">)</span> keyContext<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">advanceWatermark</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        currentWatermark <span class="token operator">=</span> time<span class="token punctuation">;</span>
    
        <span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">;</span>
    
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timer <span class="token operator">=</span> eventTimeTimersQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> timer<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eventTimeTimersQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyContext<span class="token punctuation">.</span><span class="token function">setCurrentKey</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            triggerTarget<span class="token punctuation">.</span><span class="token function">onEventTime</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>我们可以继续深入看到advanceWatermark方法在InternalTimeServiceManagerImpl中被调用，继续向上看，其实是AbstractStreamOperator调用。也就是说AbstractStreamOperator使用InternalTimeServiceManager管理所有的InternalTimerService。在InternalTimeServiceManager内部，AbstractStreamOperator在获取InternalTimerService是必须指定名称，这样可以方便将不同的触发对象Triggerable绑定到不同的InternalTimerService中。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalTimeServiceManagerImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InternalTimeServiceManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 所有的InternalTimerServiceImpl和名称的映射关系</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">InternalTimerServiceImpl</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> timerServices<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">InternalTimeServiceManagerImpl</span><span class="token punctuation">(</span>
            <span class="token class-name">KeyGroupRange</span> localKeyGroupRange<span class="token punctuation">,</span>
            <span class="token class-name">KeyContext</span> keyContext<span class="token punctuation">,</span>
            <span class="token class-name">PriorityQueueSetFactory</span> priorityQueueSetFactory<span class="token punctuation">,</span>
            <span class="token class-name">ProcessingTimeService</span> processingTimeService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token keyword">this</span><span class="token punctuation">.</span>localKeyGroupRange <span class="token operator">=</span> <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>localKeyGroupRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>priorityQueueSetFactory <span class="token operator">=</span> <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>priorityQueueSetFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keyContext <span class="token operator">=</span> <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>keyContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>processingTimeService <span class="token operator">=</span> <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>processingTimeService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">this</span><span class="token punctuation">.</span>timerServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 获取InternalTimerService，必须指定名称</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">InternalTimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInternalTimerService</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> name<span class="token punctuation">,</span>
            <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keySerializer<span class="token punctuation">,</span>
            <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> namespaceSerializer<span class="token punctuation">,</span>
            <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> triggerable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>keySerializer<span class="token punctuation">,</span> <span class="token string">&quot;Timers can only be used on keyed operators.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// the following casting is to overcome type restrictions.</span>
        <span class="token class-name">TimerSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timerSerializer <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">TimerSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>keySerializer<span class="token punctuation">,</span> namespaceSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timerService <span class="token operator">=</span>
                <span class="token function">registerOrGetTimerService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> timerSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        timerService<span class="token punctuation">.</span><span class="token function">startTimerService</span><span class="token punctuation">(</span>
                timerSerializer<span class="token punctuation">.</span><span class="token function">getKeySerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                timerSerializer<span class="token punctuation">.</span><span class="token function">getNamespaceSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                triggerable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">return</span> timerService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerOrGetTimerService</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">TimerSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timerSerializer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> timerService <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> timerServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timerService <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
            timerService <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            localKeyGroupRange<span class="token punctuation">,</span>
                            keyContext<span class="token punctuation">,</span>
                            processingTimeService<span class="token punctuation">,</span>
                            <span class="token function">createTimerPriorityQueue</span><span class="token punctuation">(</span>
                                    PROCESSING_TIMER_PREFIX <span class="token operator">+</span> name<span class="token punctuation">,</span> timerSerializer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token function">createTimerPriorityQueue</span><span class="token punctuation">(</span>EVENT_TIMER_PREFIX <span class="token operator">+</span> name<span class="token punctuation">,</span> timerSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            timerServices<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> timerService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> timerService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">advanceWatermark</span><span class="token punctuation">(</span><span class="token class-name">Watermark</span> watermark<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InternalTimerServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> service <span class="token operator">:</span> timerServices<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            service<span class="token punctuation">.</span><span class="token function">advanceWatermark</span><span class="token punctuation">(</span>watermark<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">StreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
                <span class="token class-name">SetupableStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
                <span class="token class-name">CheckpointedStreamOperator</span><span class="token punctuation">,</span>
                <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">InternalTimeServiceManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> timeServiceManager<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">InternalTimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInternalTimerService</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> namespaceSerializer<span class="token punctuation">,</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> triggerable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeServiceManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;The timer service has not been initialized.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
        <span class="token class-name">InternalTimeServiceManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keyedTimeServiceHandler <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token class-name">InternalTimeServiceManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> timeServiceManager<span class="token punctuation">;</span>
        <span class="token class-name">KeyedStateBackend</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keyedStateBackend <span class="token operator">=</span> <span class="token function">getKeyedStateBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkState</span><span class="token punctuation">(</span>keyedStateBackend <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Timers can only be used on keyed operators.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyedTimeServiceHandler<span class="token punctuation">.</span><span class="token function">getInternalTimerService</span><span class="token punctuation">(</span>
                name<span class="token punctuation">,</span> keyedStateBackend<span class="token punctuation">.</span><span class="token function">getKeySerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namespaceSerializer<span class="token punctuation">,</span> triggerable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 处理watermark</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processWatermark</span><span class="token punctuation">(</span><span class="token class-name">Watermark</span> mark<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeServiceManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeServiceManager<span class="token punctuation">.</span><span class="token function">advanceWatermark</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        output<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><p>从AbastractStreamOperator的类继承图中可以看出，基本所有的Operator都继承了AbstractStreamOperator，也就是说所有的operator都可以通过InternalTimeServiceManager来管理InternalTimerService，接下来我们看看在KeyedProcessOperator中是如何实现的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRichFunction</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">// 处理输入流中的每一个元素的逻辑</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">I</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">// 当TimerService设置的定时器触发时调用逻辑进行计算</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Long</span> <span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">TimerService</span> <span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">&gt;</span></span> outputTag<span class="token punctuation">,</span> <span class="token class-name">X</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">K</span> <span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">OnTimerContext</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">TimeDomain</span> <span class="token function">timeDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">K</span> <span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyedProcessOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractUdfStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">VoidNamespace</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 在处理元素之前会调用，进行状态等其他组件的初始化
     *
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimestampedCollector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 不需要命名空间的差异，可以使用VoidNamespaceSerializer</span>
        <span class="token comment">// 调用AbstractStreamOperator的getInternalTimerService底层调用了InternalTimeServiceManager的getInternalTimerService方法</span>
        <span class="token class-name">InternalTimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoidNamespace</span><span class="token punctuation">&gt;</span></span> internalTimerService <span class="token operator">=</span>
                <span class="token function">getInternalTimerService</span><span class="token punctuation">(</span><span class="token string">&quot;user-timers&quot;</span><span class="token punctuation">,</span> <span class="token class-name">VoidNamespaceSerializer</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 使用internalTimerService构造timerService</span>
        <span class="token class-name">TimerService</span> timerService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleTimerService</span><span class="token punctuation">(</span>internalTimerService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span>userFunction<span class="token punctuation">,</span> timerService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        onTimerContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnTimerContextImpl</span><span class="token punctuation">(</span>userFunction<span class="token punctuation">,</span> timerService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 事件时间触发
     *
     * @param timer timer定时器
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEventTime</span><span class="token punctuation">(</span><span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">VoidNamespace</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        collector<span class="token punctuation">.</span><span class="token function">setAbsoluteTimestamp</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">invokeUserFunction</span><span class="token punctuation">(</span><span class="token class-name">TimeDomain</span><span class="token punctuation">.</span>EVENT_TIME<span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 处理时间触发
     *
     * @param timer timer定时器
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">VoidNamespace</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        collector<span class="token punctuation">.</span><span class="token function">eraseTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">invokeUserFunction</span><span class="token punctuation">(</span><span class="token class-name">TimeDomain</span><span class="token punctuation">.</span>PROCESSING_TIME<span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeUserFunction</span><span class="token punctuation">(</span><span class="token class-name">TimeDomain</span> timeDomain<span class="token punctuation">,</span> <span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">VoidNamespace</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        onTimerContext<span class="token punctuation">.</span>timeDomain <span class="token operator">=</span> timeDomain<span class="token punctuation">;</span>
        onTimerContext<span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token comment">// 触发用户逻辑的函数计算</span>
        userFunction<span class="token punctuation">.</span><span class="token function">onTimer</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> onTimerContext<span class="token punctuation">,</span> collector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        onTimerContext<span class="token punctuation">.</span>timeDomain <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        onTimerContext<span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><h4 id="_4-window"><a href="#_4-window" class="header-anchor">#</a> 4. Window</h4> <p>下面我们继续看看Window和WindowAssigner以及MergingWindowAssigner的关系及其具体实现。</p> <p><img src="http://yanko.test.upcdn.net/images/Window.png" alt=""></p> <p>Window类的具体实现类是TimeWindow和GlobalWindow，TimeWindow就是时间窗口，每个窗口都有一个start和end，可以对时间窗口进行合并，主要体现在Session Window中，图中可以看到Session Window实现了MergingWindowAssigner；还有一类就是GlobalWindow也就是全局窗口，所有的数据都属于该窗口，采用了恶汉式单例设计模式实现。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Window</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Gets the largest timestamp that still belongs to this window.
     * 获取属于此窗口的最大时间戳
     *
     * @return The largest timestamp that still belongs to this window.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">long</span> <span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeWindow</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> start<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> end<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">(</span><span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">long</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Gets the largest timestamp that still belongs to this window.
     * 获取属于此窗口的最大时间戳，在TimeWindow中体现为窗口的结束时间戳-1
     *
     * &lt;p&gt;This timestamp is identical to {@code getEnd() - 1}.
     *
     * @return The largest timestamp that still belongs to this window.
     * @see #getEnd()
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Method to get the window start for a timestamp.
     * 获取窗口开始的时间戳
     *
     * @param timestamp epoch millisecond to get the window start.
     * @param offset The offset which window start would be shifted by.
     * @param windowSize The size of the generated windows.
     * @return window start
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getWindowStartWithOffset</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> windowSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">-</span> <span class="token punctuation">(</span>timestamp <span class="token operator">-</span> offset <span class="token operator">+</span> windowSize<span class="token punctuation">)</span> <span class="token operator">%</span> windowSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalWindow</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">GlobalWindow</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GlobalWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">GlobalWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">GlobalWindow</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h4 id="_5-windowassigner"><a href="#_5-windowassigner" class="header-anchor">#</a> 5. WindowAssigner</h4> <p>WindowAssigner是实现元素的窗口分配的主要组件，一个元素可能属于一个或多个窗口。在其对应的子类实现的构造方法中会对窗口的一些参数进行校验，如果出现问题就会抛出异常。确定每个元素属于那个窗口的方法主要是assignWindow方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">WindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Returns a {@code Collection} of windows that should be assigned to the element.
     * 返回应分配给元素的窗口的集合
     *
     * @param element The element to which windows should be assigned.
     * @param timestamp The timestamp of the element.
     * @param context The {@link WindowAssignerContext} in which the assigner operates.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">assignWindows</span><span class="token punctuation">(</span>
            <span class="token class-name">T</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">WindowAssignerContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** 
     * Returns the default trigger associated with this {@code WindowAssigner}. 
     * 返回默认的Trigger
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDefaultTrigger</span><span class="token punctuation">(</span><span class="token class-name">StreamExecutionEnvironment</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Returns a {@link TypeSerializer} for serializing windows that are assigned by this {@code
     * WindowAssigner}.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">getWindowSerializer</span><span class="token punctuation">(</span><span class="token class-name">ExecutionConfig</span> executionConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Returns {@code true} if elements are assigned to windows based on event time, {@code false}
     * otherwise.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">isEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * A context provided to the {@link WindowAssigner} that allows it to query the current
     * processing time.
     *
     * &lt;p&gt;This is provided to the assigner by its containing {@link
     * org.apache.flink.streaming.runtime.operators.windowing.WindowOperator}, which, in turn, gets
     * it from the containing {@link org.apache.flink.streaming.runtime.tasks.StreamTask}.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowAssignerContext</span> <span class="token punctuation">{</span>

        <span class="token comment">/** Returns the current processing time. */</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">long</span> <span class="token function">getCurrentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>从上面的类继承图我们可以看到，WindowAssigner的实现类主要有以下4个，分别是：</p> <ul><li>TumblingEventTimeWindows：滚动窗口，使用事件时间语义</li> <li>TumblingProcessingTimeWindows：滚动窗口，使用处理时间语义</li> <li>SlidingEventTimeWindows：滑动窗口，使用事件时间语义</li> <li>SlidingProcessingTimeWindows：滑动窗口，使用处理时间语义</li></ul> <p>我们主要看看EventTime语义对应的两种窗口对应的assignWindows的实现以及其默认的触发器Trigger。</p> <h5 id="_1-计算所属窗口-assignwindows"><a href="#_1-计算所属窗口-assignwindows" class="header-anchor">#</a> 1. 计算所属窗口（assignWindows）</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * TumblingEventTimeWindows
 * 对每个数据计算其所属的时间窗口，计算窗口开始时间的逻辑：【当前数据时间 - (当前数据时间 - 时间偏移量 + 窗口大小) % 窗口大小】
 * @param element The element to which windows should be assigned.
 * @param timestamp The timestamp of the element.
 * @param context The {@link WindowAssignerContext} in which the assigner operates.
 * @return
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token function">assignWindows</span><span class="token punctuation">(</span>
        <span class="token class-name">Object</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">WindowAssignerContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&gt;</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>staggerOffset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用getStaggerOffset计算每个窗口所分配的错开的偏移量，默认是ALIGNED，为0</span>
            staggerOffset <span class="token operator">=</span>
                    windowStagger<span class="token punctuation">.</span><span class="token function">getStaggerOffset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurrentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Long.MIN_VALUE is currently assigned when no timestamp is present</span>
        <span class="token comment">// 调用getWindowStartWithOffset获取窗口的开始时间</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span>
                <span class="token class-name">TimeWindow</span><span class="token punctuation">.</span><span class="token function">getWindowStartWithOffset</span><span class="token punctuation">(</span>
                        timestamp<span class="token punctuation">,</span> <span class="token punctuation">(</span>globalOffset <span class="token operator">+</span> staggerOffset<span class="token punctuation">)</span> <span class="token operator">%</span> size<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 窗口计算逻辑：【窗口开始时间, 窗口开始时间 + 窗口大小】</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Record has Long.MIN_VALUE timestamp (= no timestamp marker). &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;Is the time characteristic set to 'ProcessingTime', or did you forget to call &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;'DataStream.assignTimestampsAndWatermarks(...)'?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * SlidingEventTimeWindows
 * 对每个数据计算其所属的时间窗口，计算最后一个窗口开始时间的逻辑：【当前数据时间 - (当前数据时间 - 时间偏移量 + 窗口大小) % 窗口大小】
 * @param element The element to which windows should be assigned.
 * @param timestamp The timestamp of the element.
 * @param context The {@link WindowAssignerContext} in which the assigner operates.
 * @return
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token function">assignWindows</span><span class="token punctuation">(</span>
        <span class="token class-name">Object</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">WindowAssignerContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&gt;</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计算窗口的格式：size / slide</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> windows <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size <span class="token operator">/</span> slide<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用getWindowStartWithOffset获取最后一个窗口的开始时间</span>
        <span class="token keyword">long</span> lastStart <span class="token operator">=</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">.</span><span class="token function">getWindowStartWithOffset</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> slide<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算元素所属窗口：当前窗口的时间 &gt; 当前数据时间 - 窗口大小，循环继续，每次减少滑动步长slide</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> start <span class="token operator">=</span> lastStart<span class="token punctuation">;</span> start <span class="token operator">&gt;</span> timestamp <span class="token operator">-</span> size<span class="token punctuation">;</span> start <span class="token operator">-=</span> slide<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加窗口到集合中</span>
            windows<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> windows<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Record has Long.MIN_VALUE timestamp (= no timestamp marker). &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;Is the time characteristic set to 'ProcessingTime', or did you forget to call &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;'DataStream.assignTimestampsAndWatermarks(...)'?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h5 id="_2-窗口触发器"><a href="#_2-窗口触发器" class="header-anchor">#</a> 2. 窗口触发器</h5> <p>对于TumblingEventTimeWindows和SlidingEventTimeWindows两种窗口，它们默认的触发器均是EventTimeTrigger。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventTimeTrigger</span> <span class="token keyword">extends</span> <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">EventTimeTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onElement</span><span class="token punctuation">(</span>
            <span class="token class-name">Object</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> ctx<span class="token punctuation">.</span><span class="token function">getCurrentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// if the watermark is already past the window fire immediately</span>
            <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>FIRE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onEventTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> time <span class="token operator">==</span> window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>FIRE <span class="token operator">:</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMerge</span><span class="token punctuation">(</span><span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">OnMergeContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// only register a timer if the watermark is not yet past the end of the merged window</span>
        <span class="token comment">// this is in line with the logic in onElement(). If the watermark is past the end of</span>
        <span class="token comment">// the window onElement() will fire and setting a timer here would fire the window twice.</span>
        <span class="token keyword">long</span> windowMaxTimestamp <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowMaxTimestamp <span class="token operator">&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">getCurrentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>windowMaxTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;EventTimeTrigger()&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Creates an event-time trigger that fires once the watermark passes the end of the window.
     *
     * &lt;p&gt;Once the trigger fires all elements are discarded. Elements that arrive late immediately
     * trigger window evaluation with just this one element.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">EventTimeTrigger</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventTimeTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>对于ProcessingTime中默认使用的触发器是ProcessingTimeTrigger，其实现逻辑相对来说比较简单，可以自行阅读ProcessingTime对应窗口的assignWindows以及其默认的触发器源码。</p> <h4 id="_6-mergingwindowassigner"><a href="#_6-mergingwindowassigner" class="header-anchor">#</a> 6. MergingWindowAssigner</h4> <p>MergingWindowAssigner是WindowAssigner的抽象子类，主要是提供了对时间窗口的合并功能。MergingWindowAssigner抽象类的定义逻辑十分简单。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MergingWindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">WindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Determines which windows (if any) should be merged.
     * 确定要进行合并的窗口
     *
     * @param windows The window candidates.
     * @param callback A callback that can be invoked to signal which windows should be merged.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">mergeWindows</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windows<span class="token punctuation">,</span> <span class="token class-name">MergeCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Callback to be used in {@link #mergeWindows(Collection, MergeCallback)} for specifying which
     * windows should be merged.
     * 指定哪些窗口需要被合并
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MergeCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token comment">/**
         * Specifies that the given windows should be merged into the result window.
         *
         * @param toBeMerged The list of windows that should be merged into one window.
         * @param mergeResult The resulting merged window.
         */</span>
        <span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> toBeMerged<span class="token punctuation">,</span> <span class="token class-name">W</span> mergeResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>MergingWindowAssigner的实现有以下四个子类，分别是：</p> <ul><li>EventTimeSessionWindows：会话窗口，使用事件时间语义</li> <li>DynamicEventTimeSessionWindows：动态会话窗口，使用️事件时间语义</li> <li>ProcessingTimeSessionWindows：会话窗口，使用处理时间语义</li> <li>DynamicProcessingTimeSessionWindows：动态会话窗口，使用处理时间语义</li></ul> <p>我们重点看看EventTime语义的两种会话窗口，先看看EventTimeSessionWindows对应的具体实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventTimeSessionWindows</span> <span class="token keyword">extends</span> <span class="token class-name">MergingWindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token function">assignWindows</span><span class="token punctuation">(</span>
            <span class="token class-name">Object</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">WindowAssignerContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回计算的窗口</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> timestamp <span class="token operator">+</span> sessionTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDefaultTrigger</span><span class="token punctuation">(</span><span class="token class-name">StreamExecutionEnvironment</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">EventTimeTrigger</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mergeWindows</span><span class="token punctuation">(</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> windows<span class="token punctuation">,</span> <span class="token class-name">MergingWindowAssigner<span class="token punctuation">.</span>MergeCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeWindow</span><span class="token punctuation">.</span><span class="token function">mergeWindows</span><span class="token punctuation">(</span>windows<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>DynamicEventTimeSessionWindows和EventTimeSessionWindows中assignWindows实现几乎差不多，使用的默认触发器也是EventTimeTrigger。这两种窗口目前就我本人而言使用相对较少，就不做深入的研究。我们可以看到具体合并窗口的源码，调用的是TimeWindow的mergeWindows的实现。可以看看这部分是对窗口如何进行合并的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeWindow</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mergeWindows</span><span class="token punctuation">(</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> windows<span class="token punctuation">,</span> <span class="token class-name">MergingWindowAssigner<span class="token punctuation">.</span>MergeCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token comment">// sort the windows by the start time and then merge overlapping windows</span>
        <span class="token comment">// 对窗口按照开始时间进行排序，然后合并重叠的窗口</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> sortedWindows <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>windows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>
                sortedWindows<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">TimeWindow</span> o1<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o2<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> merged <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> currentMerge <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 对排序窗口进行遍历</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TimeWindow</span> candidate <span class="token operator">:</span> sortedWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMerge <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                currentMerge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentMerge<span class="token punctuation">.</span>f0 <span class="token operator">=</span> candidate<span class="token punctuation">;</span>
                currentMerge<span class="token punctuation">.</span>f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentMerge<span class="token punctuation">.</span>f1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMerge<span class="token punctuation">.</span>f0<span class="token punctuation">.</span><span class="token function">intersects</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// intersects: 如果currentMerge.f0的窗口和candidate窗口相交或者窗口的开始或结束时间刚好相等，则为true</span>
                <span class="token comment">// cover: 取currentMerge.f0和candidate窗口中start的最小值以及end的最大值，即合并窗口</span>
                currentMerge<span class="token punctuation">.</span>f0 <span class="token operator">=</span> currentMerge<span class="token punctuation">.</span>f0<span class="token punctuation">.</span><span class="token function">cover</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentMerge<span class="token punctuation">.</span>f1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果窗口不存在重叠，则将结果写入merged中，继续循环之前的操作，直到sortedWindows元素循环结束为止</span>
                merged<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentMerge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentMerge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentMerge<span class="token punctuation">.</span>f0 <span class="token operator">=</span> candidate<span class="token punctuation">;</span>
                currentMerge<span class="token punctuation">.</span>f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentMerge<span class="token punctuation">.</span>f1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 循环结束后如果currentMerge还有窗口信息，则直接写入merged中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMerge <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            merged<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentMerge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 对merged窗口进行遍历，主要是为了更改其数据结构</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> m <span class="token operator">:</span> merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>f1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                c<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>f1<span class="token punctuation">,</span> m<span class="token punctuation">.</span>f0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>接下来还有一种窗口：全局窗口GlobalWindow，是区别于两种时间语义对应的窗口之外的特殊窗口，我们继续看看它的具体实现。</p> <h4 id="_7-globalwindows"><a href="#_7-globalwindows" class="header-anchor">#</a> 7. GlobalWindows</h4> <p>GlobalWindows是全局窗口，将所有的数据全部纳入一个窗口中进行处理，在日常使用中比较少遇见。GlobalWindows也是直接继承自WindowAssigner，使用的默认触发器是NeverTrigger，我们具体深入看看其实现。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalWindows</span> <span class="token keyword">extends</span> <span class="token class-name">WindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">GlobalWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">GlobalWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GlobalWindow</span><span class="token punctuation">&gt;</span></span> <span class="token function">assignWindows</span><span class="token punctuation">(</span>
            <span class="token class-name">Object</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">WindowAssignerContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token class-name">GlobalWindow</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">GlobalWindow</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDefaultTrigger</span><span class="token punctuation">(</span><span class="token class-name">StreamExecutionEnvironment</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NeverTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Creates a new {@code GlobalWindows} {@link WindowAssigner} that assigns all elements to the
     * same {@link GlobalWindow}.
     *
     * @return The global window policy.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">GlobalWindows</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GlobalWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** A trigger that never fires, as default Trigger for GlobalWindows. */</span>
    <span class="token annotation punctuation">@Internal</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">NeverTrigger</span> <span class="token keyword">extends</span> <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">GlobalWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onElement</span><span class="token punctuation">(</span>
                <span class="token class-name">Object</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">GlobalWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onEventTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">GlobalWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">GlobalWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token class-name">GlobalWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMerge</span><span class="token punctuation">(</span><span class="token class-name">GlobalWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">OnMergeContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>至此，窗口的基本实现我们就大概看完了，接下来我们看看对于Keyed Stream和Non-Keyed Stream所对应的Stream在Flink中是如何被处理的。</p> <h4 id="_8-windowedstream"><a href="#_8-windowedstream" class="header-anchor">#</a> 8. WindowedStream</h4> <p>Window操作的主要处理逻辑在WindowOperator中，由于window的使用场景比较灵活，窗口中的计算分为全量窗口计算和增量窗口计算。从这两方面入手看看Flink中的Window操作是如何实现的。</p> <h5 id="_1-全量窗口处理逻辑"><a href="#_1-全量窗口处理逻辑" class="header-anchor">#</a> 1. 全量窗口处理逻辑</h5> <p>先来看看WindowOpeartor的构造方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractUdfStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">InternalWindowFunction</span><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">WindowOperator</span><span class="token punctuation">(</span>
            <span class="token class-name">WindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> IN<span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowAssigner<span class="token punctuation">,</span>
            <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowSerializer<span class="token punctuation">,</span>
            <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keySelector<span class="token punctuation">,</span>
            <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keySerializer<span class="token punctuation">,</span>
            <span class="token class-name">StateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">AppendingState</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> ACC<span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> windowStateDescriptor<span class="token punctuation">,</span>
            <span class="token class-name">InternalWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowFunction<span class="token punctuation">,</span>
            <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> IN<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> trigger<span class="token punctuation">,</span>
            <span class="token keyword">long</span> allowedLateness<span class="token punctuation">,</span>
            <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> lateDataOutputTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token keyword">super</span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token function">checkArgument</span><span class="token punctuation">(</span>
                <span class="token operator">!</span><span class="token punctuation">(</span>windowAssigner <span class="token keyword">instanceof</span> <span class="token class-name">BaseAlignedWindowAssigner</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;The &quot;</span>
                        <span class="token operator">+</span> windowAssigner<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">&quot; cannot be used with a WindowOperator. &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;This assigner is only used with the AccumulatingProcessingTimeWindowOperator and &quot;</span>
                        <span class="token operator">+</span> <span class="token string">&quot;the AggregatingProcessingTimeWindowOperator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token function">checkArgument</span><span class="token punctuation">(</span>allowedLateness <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token function">checkArgument</span><span class="token punctuation">(</span>
                windowStateDescriptor <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> windowStateDescriptor<span class="token punctuation">.</span><span class="token function">isSerializerInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;window state serializer is not properly initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">this</span><span class="token punctuation">.</span>windowAssigner <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>windowAssigner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>windowSerializer <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>windowSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keySelector <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>keySelector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keySerializer <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>keySerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>windowStateDescriptor <span class="token operator">=</span> windowStateDescriptor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>trigger <span class="token operator">=</span> <span class="token function">checkNotNull</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allowedLateness <span class="token operator">=</span> allowedLateness<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lateDataOutputTag <span class="token operator">=</span> lateDataOutputTag<span class="token punctuation">;</span>
    
        <span class="token function">setChainingStrategy</span><span class="token punctuation">(</span><span class="token class-name">ChainingStrategy</span><span class="token punctuation">.</span>ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>从上面WindowOperator的构造方法中看出所需要的有WindowAssigner、StateDescriptor, ?&gt;、InternalWindowFunction以及Trigger。其中的State必须是AppendingState的子类，在Flink中，AppendingState的子类有ListState、AggregatingState、ReducingState以及InternalMergingState。InternalWindowFunction是窗口的计算函数。在Flink的内部使用，不对外暴露。</p> <p>在使用窗口时，通过ProcessWindowFunction指定计算逻辑，在通过WindowOperatorBuilder中的process方法，包装成InternalIterableProcessWindowFunction，也就是InternalWindowFunction的子类，最终提供给WindowOperator，在window中使用的状态是ListState。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">WindowedStream</span><span class="token punctuation">(</span><span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">WindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowAssigner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token keyword">this</span><span class="token punctuation">.</span>input <span class="token operator">=</span> input<span class="token punctuation">;</span>
    
        <span class="token keyword">this</span><span class="token punctuation">.</span>builder <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">WindowOperatorBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                        windowAssigner<span class="token punctuation">,</span>
                        windowAssigner<span class="token punctuation">.</span><span class="token function">getDefaultTrigger</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        input<span class="token punctuation">.</span><span class="token function">getExecutionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        input<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        input<span class="token punctuation">.</span><span class="token function">getKeySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        input<span class="token punctuation">.</span><span class="token function">getKeyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> resultType <span class="token operator">=</span>
                <span class="token function">getProcessWindowFunctionReturnType</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> <span class="token function">getInputType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">return</span> <span class="token function">process</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> resultType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 将给定的函数应用于每个窗口</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">process</span><span class="token punctuation">(</span>
            <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">,</span> <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> resultType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        function <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">final</span> <span class="token class-name">String</span> opName <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">generateOperatorName</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> operator <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>opName<span class="token punctuation">,</span> resultType<span class="token punctuation">,</span> operator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperatorBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> <span class="token string">&quot;ProcessWindowFunction cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InternalIterableProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">apply</span><span class="token punctuation">(</span>
            <span class="token class-name">InternalWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Iterable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evictor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">buildEvictingWindowOperator</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> stateDesc <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            WINDOW_STATE_NAME<span class="token punctuation">,</span> inputType<span class="token punctuation">.</span><span class="token function">createSerializer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token keyword">return</span> <span class="token function">buildWindowOperator</span><span class="token punctuation">(</span>stateDesc<span class="token punctuation">,</span> function<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>在上面我们只是看了WindowOperator的构造方法，我们看看其open方法，也就是刚刚进来就会调用的方法，主要是进行初始化等操作。在WindowOperator.open()方法中，调用getInternalTimerService创建一个名为window-timers的InternalTimerService用于注册定时器，定时器的触发对象是WindowOperator，WindowOperator对Triggerable进行了实现。同时，在open方法中还会创建各种上下文对象，包括TriggerContext、WindowAssignerContext等，也会进行状态的初始化。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractUdfStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">InternalWindowFunction</span><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">this</span><span class="token punctuation">.</span>numLateRecordsDropped <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">counter</span><span class="token punctuation">(</span>LATE_ELEMENTS_DROPPED_METRIC_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timestampedCollector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimestampedCollector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 通过getInternalTimerService创建一个internalTimerService对象，名称为window-timers</span>
        internalTimerService <span class="token operator">=</span> <span class="token function">getInternalTimerService</span><span class="token punctuation">(</span><span class="token string">&quot;window-timers&quot;</span><span class="token punctuation">,</span> windowSerializer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        triggerContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        processContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        windowAssignerContext <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">WindowAssigner<span class="token punctuation">.</span>WindowAssignerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCurrentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> internalTimerService<span class="token punctuation">.</span><span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
        <span class="token comment">// create (or restore) the state that hold the actual window contents</span>
        <span class="token comment">// NOTE - the state may be null in the case of the overriding evicting window operator</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStateDescriptor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            windowState <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">InternalAppendingState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> ACC<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                            <span class="token function">getOrCreateKeyedState</span><span class="token punctuation">(</span>windowSerializer<span class="token punctuation">,</span> windowStateDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// create the typed and helper states for merging windows</span>
        <span class="token comment">// 判断此时传入的窗口是否是MergingWindowAssigner的子类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowAssigner <span class="token keyword">instanceof</span> <span class="token class-name">MergingWindowAssigner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
            <span class="token comment">// store a typed reference for the state of merging windows - sanity check</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>windowState <span class="token keyword">instanceof</span> <span class="token class-name">InternalMergingState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                windowMergingState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InternalMergingState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> ACC<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> windowState<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// TODO this sanity check should be here, but is prevented by an incorrect test (pending</span>
            <span class="token comment">// validation)</span>
            <span class="token comment">// TODO see WindowOperatorTest.testCleanupTimerWithEmptyFoldingStateForSessionWindows()</span>
            <span class="token comment">// TODO activate the sanity check once resolved</span>
            <span class="token comment">//       else if (windowState != null) {</span>
            <span class="token comment">//          throw new IllegalStateException(</span>
            <span class="token comment">//                &quot;The window uses a merging assigner, but the window state is not mergeable.&quot;);</span>
            <span class="token comment">//       }</span>
    
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typedTuple <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    
            <span class="token keyword">final</span> <span class="token class-name">TupleSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tupleSerializer <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">TupleSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            typedTuple<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeSerializer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>windowSerializer<span class="token punctuation">,</span> windowSerializer<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token keyword">final</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mergingSetsStateDescriptor <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;merging-window-set&quot;</span><span class="token punctuation">,</span> tupleSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token comment">// get the state that stores the merging sets</span>
            mergingSetsState <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">InternalListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">VoidNamespace</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                            <span class="token function">getOrCreateKeyedState</span><span class="token punctuation">(</span>
                                    <span class="token class-name">VoidNamespaceSerializer</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">,</span> mergingSetsStateDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mergingSetsState<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span><span class="token class-name">VoidNamespace</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>当消息到达之后，在窗口中的处理流程大致如下：</p> <p><img src="http://yanko.test.upcdn.net/images/window-process.png" alt=""></p> <ul><li>通过WindowAssigner.assignWindows确定消息所在的窗口（可能属于一个或者多个窗口）</li> <li>将消息加入到对应窗口的windowState中</li> <li>根据triggerContext.onElement判断窗口是否要触发计算（底层调用触发器的onElement方法）</li> <li>如果需要触发计算，调用emitWindowContents对窗口内的内容进行处理（底层调用InternalIterableProcessWindowFunction的process方法进一步调用ProcessWindowFunction的process方法处理）</li> <li>通过registerCleanupTimer注册一个清理窗口的定时器，在窗口结束时清理状态</li> <li>如果消息到达的太晚，通过sideOutput提交到侧输出流中</li> <li>当定时器到期时，调用Trigger.onEventTime或Trigger.onProcessingTime判断是否需要触发窗口的计算；如果是清除窗口的定时器，则调用clear方法清理窗口的状态</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractUdfStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">InternalWindowFunction</span><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用WindowAssigner.assignWindows确定每条消息所在的窗口</span>
        <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> elementWindows <span class="token operator">=</span>
                windowAssigner<span class="token punctuation">.</span><span class="token function">assignWindows</span><span class="token punctuation">(</span>
                        element<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> windowAssignerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// if element is handled by none of assigned elementWindows</span>
        <span class="token keyword">boolean</span> isSkippedElement <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    
        <span class="token keyword">final</span> <span class="token class-name">K</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span><span class="token function">getKeyedStateBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 如果是MergingWindowAssigner的子类，需要执行以下逻辑</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowAssigner <span class="token keyword">instanceof</span> <span class="token class-name">MergingWindowAssigner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MergingWindowSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergingWindows <span class="token operator">=</span> <span class="token function">getMergingWindowSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* ... */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不是MergingWindowAssigner的子类，也就是正常的WindowAssigner的窗口描述器</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">W</span> window <span class="token operator">:</span> elementWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
                <span class="token comment">// drop if the window is already late</span>
                <span class="token comment">// 如果窗口已经晚了，继续循环，暂时不做处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isWindowLate</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                isSkippedElement <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
                windowState<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将消息写入window状态中</span>
                windowState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                triggerContext<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
                triggerContext<span class="token punctuation">.</span>window <span class="token operator">=</span> window<span class="token punctuation">;</span>
    
                <span class="token comment">// 调用TriggerContext.onElement确定是否要触发该窗口的计算</span>
                <span class="token class-name">TriggerResult</span> triggerResult <span class="token operator">=</span> triggerContext<span class="token punctuation">.</span><span class="token function">onElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                <span class="token comment">// 需要触发该窗口的计算</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerResult<span class="token punctuation">.</span><span class="token function">isFire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ACC</span> contents <span class="token operator">=</span> windowState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>contents <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 使用InternalWindowFunction对窗口的内容进行处理</span>
                    <span class="token function">emitWindowContents</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    
                <span class="token comment">// 清除window状态中的数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerResult<span class="token punctuation">.</span><span class="token function">isPurge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    windowState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 注册清理窗口的定时器</span>
                <span class="token function">registerCleanupTimer</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 使用侧输出流处理迟到数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSkippedElement <span class="token operator">&amp;&amp;</span> <span class="token function">isElementLate</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lateDataOutputTag <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sideOutput</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>numLateRecordsDropped<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Returns {@code true} if the watermark is after the end timestamp plus the allowed lateness of
     * the given window.
     * 判断这个窗口的watermark是否超出了窗口的结束时间+允许迟到数据的时间
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isWindowLate</span><span class="token punctuation">(</span><span class="token class-name">W</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>windowAssigner<span class="token punctuation">.</span><span class="token function">isEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">cleanupTime</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> internalTimerService<span class="token punctuation">.</span><span class="token function">currentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Returns the cleanup time for a window, which is {@code window.maxTimestamp +
     * allowedLateness}. In case this leads to a value greater than {@link Long#MAX_VALUE} then a
     * cleanup time of {@link Long#MAX_VALUE} is returned.
     * 返回窗口的清理时间，需要注意的是，这个时间是(window.maxTimestamp() + allowedLateness)的时间
     *
     * @param window the window whose cleanup time we are computing.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">cleanupTime</span><span class="token punctuation">(</span><span class="token class-name">W</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowAssigner<span class="token punctuation">.</span><span class="token function">isEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> cleanupTime <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> allowedLateness<span class="token punctuation">;</span>
            <span class="token keyword">return</span> cleanupTime <span class="token operator">&gt;=</span> window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> cleanupTime <span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onElement</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> trigger<span class="token punctuation">.</span><span class="token function">onElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Emits the contents of the given window using the {@link InternalWindowFunction}.
     * 调用InternalWindowFunction对窗口内的数据进行处理
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">emitWindowContents</span><span class="token punctuation">(</span><span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">ACC</span> contents<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        timestampedCollector<span class="token punctuation">.</span><span class="token function">setAbsoluteTimestamp</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        processContext<span class="token punctuation">.</span>window <span class="token operator">=</span> window<span class="token punctuation">;</span>
        userFunction<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
                triggerContext<span class="token punctuation">.</span>key<span class="token punctuation">,</span> window<span class="token punctuation">,</span> processContext<span class="token punctuation">,</span> contents<span class="token punctuation">,</span> timestampedCollector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Registers a timer to cleanup the content of the window.
     * 注册清理窗口内容的定时器
     *
     * @param window the window whose state to discard
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerCleanupTimer</span><span class="token punctuation">(</span><span class="token class-name">W</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> cleanupTime <span class="token operator">=</span> <span class="token function">cleanupTime</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanupTime <span class="token operator">==</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// don't set a GC timer for &quot;end of time&quot;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowAssigner<span class="token punctuation">.</span><span class="token function">isEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            triggerContext<span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>cleanupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            triggerContext<span class="token punctuation">.</span><span class="token function">registerProcessingTimeTimer</span><span class="token punctuation">(</span>cleanupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 定时器触发的处理逻辑</span>
    <span class="token comment">/**
     * 定时器触发时，进行计算
     *
     * @param timer
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEventTime</span><span class="token punctuation">(</span><span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        triggerContext<span class="token punctuation">.</span>key <span class="token operator">=</span> timer<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        triggerContext<span class="token punctuation">.</span>window <span class="token operator">=</span> timer<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">MergingWindowSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergingWindows<span class="token punctuation">;</span>
    
        <span class="token comment">/* ... */</span>
    
        <span class="token class-name">TriggerResult</span> triggerResult <span class="token operator">=</span> triggerContext<span class="token punctuation">.</span><span class="token function">onEventTime</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 触发计算</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerResult<span class="token punctuation">.</span><span class="token function">isFire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取window中的状态</span>
            <span class="token class-name">ACC</span> contents <span class="token operator">=</span> windowState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>contents <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 使用InternalWindowFunction发出指定窗口内的内容</span>
                <span class="token function">emitWindowContents</span><span class="token punctuation">(</span>triggerContext<span class="token punctuation">.</span>window<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token class-name">InternalTimer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> timer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InternalIterableProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> KEY<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">WrappingFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessWindowFunction</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> KEY<span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">InternalWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Iterable</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> KEY<span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 将窗口处理逻辑ProcessWindowFunction包装成InternalProcessWindowFunction，并调用process进行处理
     *
     * @param key key
     * @param window 窗口
     * @param context The context in which the window is being evaluated.
     * @param input The elements in the window being evaluated.
     * @param out A collector for emitting elements.
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>
            <span class="token class-name">KEY</span> key<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">W</span> window<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">InternalWindowContext</span> context<span class="token punctuation">,</span>
            <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span>
            <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>window <span class="token operator">=</span> window<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>internalContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> KEY<span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> wrappedFunction <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedFunction<span class="token punctuation">;</span>
        wrappedFunction<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> input<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br></div></div><h5 id="_2-增量窗口处理逻辑"><a href="#_2-增量窗口处理逻辑" class="header-anchor">#</a> 2. 增量窗口处理逻辑</h5> <p>通过上面对ProcessWindowFunction的分析，在其内部使用的是ListState，并且每一条数据都会写入到状态中，这样一来，肯定会存在性能问题，所以在Flink中还提供了ReduceFunction以及AggregateFunction等增量聚合的函数，ReduceFunction是AggregateFunction的一种特殊实现，我们以AggregateFunction为例，看看在Flink中增量窗口聚合是如何实现的。</p> <p>先来看看在WindowedStream中对于aggregate的定义：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 判断是否是RichFunction的子类，aggregate中的function必须是RichFunction</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>function <span class="token keyword">instanceof</span> <span class="token class-name">RichFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;This aggregation function cannot be a RichFunction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">&gt;</span></span> accumulatorType <span class="token operator">=</span>
                <span class="token class-name">TypeExtractor</span><span class="token punctuation">.</span><span class="token function">getAggregateFunctionAccumulatorType</span><span class="token punctuation">(</span>
                        function<span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> resultType <span class="token operator">=</span>
                <span class="token class-name">TypeExtractor</span><span class="token punctuation">.</span><span class="token function">getAggregateFunctionReturnType</span><span class="token punctuation">(</span>
                        function<span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 调用同名重载方法</span>
        <span class="token keyword">return</span> <span class="token function">aggregate</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> accumulatorType<span class="token punctuation">,</span> resultType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">aggregate</span><span class="token punctuation">(</span>
            <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> aggregateFunction<span class="token punctuation">,</span>
            <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowFunction<span class="token punctuation">,</span>
            <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">&gt;</span></span> accumulatorType<span class="token punctuation">,</span>
            <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> resultType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">,</span> <span class="token string">&quot;aggregateFunction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">,</span> <span class="token string">&quot;windowFunction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>accumulatorType<span class="token punctuation">,</span> <span class="token string">&quot;accumulatorType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkNotNull</span><span class="token punctuation">(</span>resultType<span class="token punctuation">,</span> <span class="token string">&quot;resultType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aggregateFunction <span class="token keyword">instanceof</span> <span class="token class-name">RichFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;This aggregate function cannot be a RichFunction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// clean the closures</span>
        <span class="token comment">// 清理执行环境中的function</span>
        windowFunction <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        aggregateFunction <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">final</span> <span class="token class-name">String</span> opName <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">generateOperatorName</span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">,</span> windowFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 调用WindowOperatorBuilder的aggregate方法</span>
        <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> operator <span class="token operator">=</span>
                builder<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">,</span> windowFunction<span class="token punctuation">,</span> accumulatorType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>opName<span class="token punctuation">,</span> resultType<span class="token punctuation">,</span> operator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperatorBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">aggregate</span><span class="token punctuation">(</span>
            <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> aggregateFunction<span class="token punctuation">,</span>
            <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowFunction<span class="token punctuation">,</span>
            <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">&gt;</span></span> accumulatorType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">,</span> <span class="token string">&quot;AggregateFunction cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">,</span> <span class="token string">&quot;WindowFunction cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aggregateFunction <span class="token keyword">instanceof</span> <span class="token class-name">RichFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;This aggregate function cannot be a RichFunction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evictor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">buildEvictingWindowOperator</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">InternalIterableWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            <span class="token keyword">new</span> <span class="token class-name">AggregateApplyWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">,</span> windowFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 此时使用的是支持聚合的AggregatingState，不是ListState，其中的聚合函数就是用户提供的aggregateFunction</span>
            <span class="token class-name">AggregatingStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> stateDesc <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">AggregatingStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            WINDOW_STATE_NAME<span class="token punctuation">,</span>
                            aggregateFunction<span class="token punctuation">,</span>
                            accumulatorType<span class="token punctuation">.</span><span class="token function">createSerializer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token keyword">return</span> <span class="token function">buildWindowOperator</span><span class="token punctuation">(</span>
                    stateDesc<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InternalSingleValueWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><p>如果使用了aggregate实现增量聚合，可以看到窗口中的状态由ListState更换成了可以聚合的AggregatingState，而状态aggregatingState中的聚合函数就是用户提供的aggregateFunction。只要有数据进来时，就会将数据添加状态中，此时就会触发状态中aggregateFunction函数的计算，这样最终的状态中只需要保存聚合后的结果即可。</p> <p>在上面直接使用AggregateFunction的情况下，无法访问窗口的上下文信息，所以可以讲增量窗口和ProcessWindowFunction结合一起使用，这样在使用增量窗口的同时也可以访问到窗口的信息。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperatorBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">aggregate</span><span class="token punctuation">(</span>
            <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> aggregateFunction<span class="token punctuation">,</span>
            <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowFunction<span class="token punctuation">,</span>
            <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">&gt;</span></span> accumulatorType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">,</span> <span class="token string">&quot;AggregateFunction cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">,</span> <span class="token string">&quot;ProcessWindowFunction cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aggregateFunction <span class="token keyword">instanceof</span> <span class="token class-name">RichFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;This aggregate function cannot be a RichFunction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evictor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">buildEvictingWindowOperator</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">InternalAggregateProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            aggregateFunction<span class="token punctuation">,</span> windowFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">AggregatingStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> stateDesc <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">AggregatingStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            WINDOW_STATE_NAME<span class="token punctuation">,</span>
                            aggregateFunction<span class="token punctuation">,</span>
                            accumulatorType<span class="token punctuation">.</span><span class="token function">createSerializer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token keyword">return</span> <span class="token function">buildWindowOperator</span><span class="token punctuation">(</span>
                    stateDesc<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InternalSingleValueProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h5 id="_3-窗口合并-session窗口"><a href="#_3-窗口合并-session窗口" class="header-anchor">#</a> 3. 窗口合并（Session窗口）</h5> <p>我们前面所看的所有逻辑都是忽略掉了窗口不合并的情况，发生窗口合并时，窗口的边界会随着消息的到来而发生改变，这种情况下窗口就会发生合并。我们从WindowOperator.open方法中除了初始化窗口的状态外，同时还会初始化一个新的mergingSetsState用于保存合并后的窗口状态。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractUdfStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">InternalWindowFunction</span><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
        
        <span class="token comment">// create (or restore) the state that hold the actual window contents</span>
        <span class="token comment">// NOTE - the state may be null in the case of the overriding evicting window operator</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStateDescriptor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            windowState <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">InternalAppendingState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> ACC<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                            <span class="token function">getOrCreateKeyedState</span><span class="token punctuation">(</span>windowSerializer<span class="token punctuation">,</span> windowStateDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// create the typed and helper states for merging windows</span>
        <span class="token comment">// 判断此时传入的窗口是否是MergingWindowAssigner的子类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowAssigner <span class="token keyword">instanceof</span> <span class="token class-name">MergingWindowAssigner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 判断窗口状态是否是InternalMergingState</span>
            <span class="token comment">// store a typed reference for the state of merging windows - sanity check</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>windowState <span class="token keyword">instanceof</span> <span class="token class-name">InternalMergingState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                windowMergingState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InternalMergingState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> ACC<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> windowState<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// TODO this sanity check should be here, but is prevented by an incorrect test (pending</span>
            <span class="token comment">// validation)</span>
            <span class="token comment">// TODO see WindowOperatorTest.testCleanupTimerWithEmptyFoldingStateForSessionWindows()</span>
            <span class="token comment">// TODO activate the sanity check once resolved</span>
            <span class="token comment">//       else if (windowState != null) {</span>
            <span class="token comment">//          throw new IllegalStateException(</span>
            <span class="token comment">//                &quot;The window uses a merging assigner, but the window state is not mergeable.&quot;);</span>
            <span class="token comment">//       }</span>
    
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typedTuple <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    
            <span class="token keyword">final</span> <span class="token class-name">TupleSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tupleSerializer <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">TupleSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            typedTuple<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeSerializer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>windowSerializer<span class="token punctuation">,</span> windowSerializer<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token keyword">final</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mergingSetsStateDescriptor <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;merging-window-set&quot;</span><span class="token punctuation">,</span> tupleSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token comment">// 创建一个InternalListState&lt;K, VoidNamespace, Tuple2&lt;W, W&gt;&gt;类型的窗口状态，用于保存合并后的状态</span>
            <span class="token comment">// get the state that stores the merging sets</span>
            mergingSetsState <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">InternalListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">VoidNamespace</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                            <span class="token function">getOrCreateKeyedState</span><span class="token punctuation">(</span>
                                    <span class="token class-name">VoidNamespaceSerializer</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">,</span> mergingSetsStateDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mergingSetsState<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span><span class="token class-name">VoidNamespace</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>相比于之前的窗口，可以合并的窗口的一个难点就在于窗口合并时状态的处理，所以对于可合并的窗口来说必须要求窗口的状态是可以合并的，可以看到必须要求状态是InternalMergingState的子类，也就是InternalListState、InternalAggregatingState和InternalReducingState。可以看到InternalMergingState继承了MergingState，在其基础上实现了mergeNamespace的方法，主要作用是将多个namespace的状态合并到目标namespace。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InternalMergingState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> SV<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">InternalAppendingState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> SV<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">MergingState</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Merges the state of the current key for the given source namespaces into the state of the
     * target namespace.
     * 将source-namespace的key的状态合并到target-namespace中
     *
     * @param target The target namespace where the merged state should be stored.
     * @param sources The source namespaces whose state should be merged.
     * @throws Exception The method may forward exception thrown internally (by I/O or functions).
     */</span>
    <span class="token keyword">void</span> <span class="token function">mergeNamespaces</span><span class="token punctuation">(</span><span class="token class-name">N</span> target<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">N</span><span class="token punctuation">&gt;</span></span> sources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>那么在WindowOperator的processElement方法中我们可以看到借助于MergingWindowSet对窗口进行合并，包括窗口的状态。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractUdfStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">InternalWindowFunction</span><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Triggerable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用WindowAssigner.assignWindows确定每条消息所在的窗口</span>
        <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> elementWindows <span class="token operator">=</span>
                windowAssigner<span class="token punctuation">.</span><span class="token function">assignWindows</span><span class="token punctuation">(</span>
                        element<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> windowAssignerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// if element is handled by none of assigned elementWindows</span>
        <span class="token keyword">boolean</span> isSkippedElement <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    
        <span class="token keyword">final</span> <span class="token class-name">K</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span><span class="token function">getKeyedStateBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 如果是MergingWindowAssigner的子类，需要执行以下逻辑</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowAssigner <span class="token keyword">instanceof</span> <span class="token class-name">MergingWindowAssigner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取MergingWindowSet，用于窗口合并</span>
            <span class="token class-name">MergingWindowSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergingWindows <span class="token operator">=</span> <span class="token function">getMergingWindowSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 遍历窗口进行合并</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">W</span> window <span class="token operator">:</span> elementWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// adding the new window might result in a merge, in that case the actualWindow</span>
                <span class="token comment">// is the merged window and we work with that. If we don't merge then</span>
                <span class="token comment">// actualWindow == window</span>
                <span class="token class-name">W</span> actualWindow <span class="token operator">=</span>
                        mergingWindows<span class="token punctuation">.</span><span class="token function">addWindow</span><span class="token punctuation">(</span>
                                window<span class="token punctuation">,</span>
                                <span class="token comment">// 合并窗口的回调函数</span>
                                <span class="token keyword">new</span> <span class="token class-name">MergingWindowSet<span class="token punctuation">.</span>MergeFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span>
                                            <span class="token comment">// 合并后的窗口</span>
                                            <span class="token class-name">W</span> mergeResult<span class="token punctuation">,</span>
                                            <span class="token comment">// 被合并的窗口</span>
                                            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergedWindows<span class="token punctuation">,</span>
                                            <span class="token comment">// 合并后窗口状态的namespace</span>
                                            <span class="token class-name">W</span> stateWindowResult<span class="token punctuation">,</span>
                                            <span class="token comment">// 别合并窗口之前的namespace</span>
                                            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergedStateWindows<span class="token punctuation">)</span>
                                            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>windowAssigner<span class="token punctuation">.</span><span class="token function">isEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                <span class="token operator">&amp;&amp;</span> mergeResult<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> allowedLateness
                                                        <span class="token operator">&lt;=</span> internalTimerService
                                                                <span class="token punctuation">.</span><span class="token function">currentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                                                    <span class="token string">&quot;The end timestamp of an &quot;</span>
                                                            <span class="token operator">+</span> <span class="token string">&quot;event-time window cannot become earlier than the current watermark &quot;</span>
                                                            <span class="token operator">+</span> <span class="token string">&quot;by merging. Current watermark: &quot;</span>
                                                            <span class="token operator">+</span> internalTimerService
                                                                    <span class="token punctuation">.</span><span class="token function">currentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                            <span class="token operator">+</span> <span class="token string">&quot; window: &quot;</span>
                                                            <span class="token operator">+</span> mergeResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>windowAssigner<span class="token punctuation">.</span><span class="token function">isEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                            <span class="token keyword">long</span> currentProcessingTime <span class="token operator">=</span>
                                                    internalTimerService<span class="token punctuation">.</span><span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeResult<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                    <span class="token operator">&lt;=</span> currentProcessingTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                                                        <span class="token string">&quot;The end timestamp of a &quot;</span>
                                                                <span class="token operator">+</span> <span class="token string">&quot;processing-time window cannot become earlier than the current processing time &quot;</span>
                                                                <span class="token operator">+</span> <span class="token string">&quot;by merging. Current processing time: &quot;</span>
                                                                <span class="token operator">+</span> currentProcessingTime
                                                                <span class="token operator">+</span> <span class="token string">&quot; window: &quot;</span>
                                                                <span class="token operator">+</span> mergeResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token punctuation">}</span>
                                        <span class="token punctuation">}</span>
    
                                        triggerContext<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
                                        triggerContext<span class="token punctuation">.</span>window <span class="token operator">=</span> mergeResult<span class="token punctuation">;</span>
                                        <span class="token comment">// 调用TriggerContext进行判断是否要进行merge</span>
                                        triggerContext<span class="token punctuation">.</span><span class="token function">onMerge</span><span class="token punctuation">(</span>mergedWindows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">W</span> m <span class="token operator">:</span> mergedWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                            triggerContext<span class="token punctuation">.</span>window <span class="token operator">=</span> m<span class="token punctuation">;</span>
                                            triggerContext<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token function">deleteCleanupTimer</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
    
                                        <span class="token comment">// merge the merged state windows into the newly resulting</span>
                                        <span class="token comment">// state window</span>
                                        <span class="token comment">// 合并窗口的状态</span>
                                        windowMergingState<span class="token punctuation">.</span><span class="token function">mergeNamespaces</span><span class="token punctuation">(</span>
                                                stateWindowResult<span class="token punctuation">,</span> mergedStateWindows<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                <span class="token comment">// drop if the window is already late</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isWindowLate</span><span class="token punctuation">(</span>actualWindow<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mergingWindows<span class="token punctuation">.</span><span class="token function">retireWindow</span><span class="token punctuation">(</span>actualWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                isSkippedElement <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
                <span class="token class-name">W</span> stateWindow <span class="token operator">=</span> mergingWindows<span class="token punctuation">.</span><span class="token function">getStateWindow</span><span class="token punctuation">(</span>actualWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stateWindow <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;Window &quot;</span> <span class="token operator">+</span> window <span class="token operator">+</span> <span class="token string">&quot; is not in in-flight window set.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    
                windowState<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span>stateWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                windowState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                triggerContext<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
                triggerContext<span class="token punctuation">.</span>window <span class="token operator">=</span> actualWindow<span class="token punctuation">;</span>
    
                <span class="token class-name">TriggerResult</span> triggerResult <span class="token operator">=</span> triggerContext<span class="token punctuation">.</span><span class="token function">onElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerResult<span class="token punctuation">.</span><span class="token function">isFire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ACC</span> contents <span class="token operator">=</span> windowState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>contents <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">emitWindowContents</span><span class="token punctuation">(</span>actualWindow<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    
                <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerResult<span class="token punctuation">.</span><span class="token function">isPurge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    windowState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">registerCleanupTimer</span><span class="token punctuation">(</span>actualWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    
            <span class="token comment">// need to make sure to update the merging state in state</span>
            mergingWindows<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">/* ... */</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// side output input event if</span>
        <span class="token comment">// element not handled by any window</span>
        <span class="token comment">// late arriving tag has been set</span>
        <span class="token comment">// windowAssigner is event time and current timestamp + allowed lateness no less than</span>
        <span class="token comment">// element timestamp</span>
        <span class="token comment">// 使用侧输出流处理迟到数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSkippedElement <span class="token operator">&amp;&amp;</span> <span class="token function">isElementLate</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lateDataOutputTag <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sideOutput</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>numLateRecordsDropped<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br></div></div><p>从上面的实现中可以看出，窗口合并的逻辑主要被封装在MergingWindowSet.addWindow中，在addWindow中最后调用合并窗口的回调函数merge的具体实现进行合并，传入的参数通过addWindow全部处理好，包括合并后的窗口、被合并的窗口以及合并后窗口的namespace和要被合并的窗口的namespace。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MergingWindowSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mapping<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">W</span> <span class="token function">addWindow</span><span class="token punctuation">(</span><span class="token class-name">W</span> newWindow<span class="token punctuation">,</span> <span class="token class-name">MergeFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergeFunction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windows <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        windows<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapping<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        windows<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 确定可以合并的窗口，在回调函数中将窗口合并的结果保存在mergeResults中</span>
        <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mergeResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        windowAssigner<span class="token punctuation">.</span><span class="token function">mergeWindows</span><span class="token punctuation">(</span>
                windows<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">MergingWindowAssigner<span class="token punctuation">.</span>MergeCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> toBeMerged<span class="token punctuation">,</span> <span class="token class-name">W</span> mergeResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Merging {} into {}&quot;</span><span class="token punctuation">,</span> toBeMerged<span class="token punctuation">,</span> mergeResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mergeResults<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mergeResult<span class="token punctuation">,</span> toBeMerged<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">W</span> resultWindow <span class="token operator">=</span> newWindow<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> mergedNewWindow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
        <span class="token comment">// perform the merge</span>
        <span class="token comment">// 执行窗口合并</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">:</span> mergeResults<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 合并后产生的窗口</span>
            <span class="token class-name">W</span> mergeResult <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 被合并的窗口</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergedWindows <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token comment">// if our new window is in the merged windows make the merge result the</span>
            <span class="token comment">// result window</span>
            <span class="token comment">// 如果新窗口在合并窗口中，则将其移出合并窗口，最后的结果也就是合并后的窗口</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mergedWindows<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>newWindow<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mergedNewWindow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                resultWindow <span class="token operator">=</span> mergeResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    
            <span class="token comment">// pick any of the merged windows and choose that window's state window</span>
            <span class="token comment">// as the state window for the merge result</span>
            <span class="token comment">// 从需要被合并的窗口中选择一个作为合并后的状态的namespace</span>
            <span class="token class-name">W</span> mergedStateWindow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapping<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mergedWindows<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token comment">// figure out the state windows that we are merging</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> mergedStateWindows <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">W</span> mergedWindow <span class="token operator">:</span> mergedWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 移除之前的映射关系</span>
                <span class="token class-name">W</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapping<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mergedWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mergedStateWindows<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    
            <span class="token comment">// 添加新的映射（合并后的窗口 -&gt; 合并后的窗口的namespace）</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mapping<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mergeResult<span class="token punctuation">,</span> mergedStateWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token comment">// don't put the target state window into the merged windows</span>
            <span class="token comment">// 从被合并的窗口中移除最终被的目标窗口</span>
            mergedStateWindows<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mergedStateWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token comment">// don't merge the new window itself, it never had any state associated with it</span>
            <span class="token comment">// i.e. if we are only merging one pre-existing window into itself</span>
            <span class="token comment">// without extending the pre-existing window</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mergedWindows<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>mergeResult<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mergedWindows<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 调用回调函数进行状态的合并</span>
                mergeFunction<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>
                        <span class="token comment">// 合并后的窗口</span>
                        mergeResult<span class="token punctuation">,</span>
                        <span class="token comment">// 需要被合并的窗口</span>
                        mergedWindows<span class="token punctuation">,</span>
                        <span class="token comment">// 用作合并后状态的namespace</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>mapping<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mergeResult<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// 需要被合并状态的namespace</span>
                        mergedStateWindows<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// the new window created a new, self-contained window without merging</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeResults<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>resultWindow<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newWindow<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mergedNewWindow<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mapping<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>resultWindow<span class="token punctuation">,</span> resultWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">return</span> resultWindow<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h5 id="_4-evictor"><a href="#_4-evictor" class="header-anchor">#</a> 4. Evictor</h5> <p>在看Window实现的底层实现的过程中，我们一直忽略了在WindowOpertorBuilder中构造WindowOperator之前有一个判断，判断evictor是否为空，如果不为空通过buildEvictorWindowOperator构造EvictingWindowOperator，否则则会通过buildWindowOperator构造WindowOperator。Evictor允许在调用InternalWindowFunction计算窗口结果之前或之后移除窗口中的元素。需要注意的是，在aggregate中如果没有Evictor使用的是AggregatingState，在设置Evictor之后将使用ListState，这将会对性能有些许影响。</p> <p>看看Evictor的接口的定义：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Evictor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Optionally evicts elements. Called before windowing function.
     * 在使用InternalWindowFunction之前调用
     *
     * @param elements The elements currently in the pane.
     * @param size The current number of elements in the pane.
     * @param window The {@link Window}
     * @param evictorContext The context for the Evictor
     */</span>
    <span class="token keyword">void</span> <span class="token function">evictBefore</span><span class="token punctuation">(</span>
            <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimestampedValue</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> elements<span class="token punctuation">,</span>
            <span class="token keyword">int</span> size<span class="token punctuation">,</span>
            <span class="token class-name">W</span> window<span class="token punctuation">,</span>
            <span class="token class-name">EvictorContext</span> evictorContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * Optionally evicts elements. Called after windowing function.
     * 在使用InternalWindowFunction之后调用
     *
     * @param elements The elements currently in the pane.
     * @param size The current number of elements in the pane.
     * @param window The {@link Window}
     * @param evictorContext The context for the Evictor
     */</span>
    <span class="token keyword">void</span> <span class="token function">evictAfter</span><span class="token punctuation">(</span>
            <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimestampedValue</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> elements<span class="token punctuation">,</span>
            <span class="token keyword">int</span> size<span class="token punctuation">,</span>
            <span class="token class-name">W</span> window<span class="token punctuation">,</span>
            <span class="token class-name">EvictorContext</span> evictorContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>Evictor的类继承关系如下：</p> <p><img src="http://yanko.test.upcdn.net/images/Evictor.png" alt=""></p> <p>Evictor在Flink中的具体实现类有以下几种：</p> <ul><li>CountEvictor：在窗口中保留一定数量的元素，超出的元素会被移除</li> <li>TimeEvictor：在一定时间内保留窗口中的元素，早于【current_time - keep_time】的元素会被移除</li> <li>DeltaEvictor：根据DeltaFunction或阈值保留元素</li></ul> <p>在使用了Evictor的情况下，最终在WindowOperatorBuilder类中会通过buildEvictingWindowOperator构造一个EvictingWindowOperator，EvictingWindowOperator是WindowOperator的子类，同时无论是aggregate增量计算还是process全量计算，都会采用全量的方式，增量计算aggregate的状态AggregatingState也会使用ListState。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowOperatorBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">aggregate</span><span class="token punctuation">(</span>
            <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> aggregateFunction<span class="token punctuation">,</span>
            <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowFunction<span class="token punctuation">,</span>
            <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span>ACC<span class="token punctuation">&gt;</span></span> accumulatorType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>aggregateFunction<span class="token punctuation">,</span> <span class="token string">&quot;AggregateFunction cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">,</span> <span class="token string">&quot;ProcessWindowFunction cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aggregateFunction <span class="token keyword">instanceof</span> <span class="token class-name">RichFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;This aggregate function cannot be a RichFunction.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evictor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当evictor不为空，调用buildEvictingWindowOperator构造EvictingWindowOperator，并使用ListState</span>
            <span class="token keyword">return</span> <span class="token function">buildEvictingWindowOperator</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">InternalAggregateProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            aggregateFunction<span class="token punctuation">,</span> windowFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">AggregatingStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> ACC<span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> stateDesc <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">AggregatingStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                            WINDOW_STATE_NAME<span class="token punctuation">,</span>
                            aggregateFunction<span class="token punctuation">,</span>
                            accumulatorType<span class="token punctuation">.</span><span class="token function">createSerializer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token keyword">return</span> <span class="token function">buildWindowOperator</span><span class="token punctuation">(</span>
                    stateDesc<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InternalSingleValueProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>windowFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildEvictingWindowOperator</span><span class="token punctuation">(</span>
            <span class="token class-name">InternalWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Iterable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> streamRecordSerializer <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                        <span class="token keyword">new</span> <span class="token class-name">StreamElementSerializer</span><span class="token punctuation">(</span>inputType<span class="token punctuation">.</span><span class="token function">createSerializer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 使用ListState状态</span>
        <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> stateDesc <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>WINDOW_STATE_NAME<span class="token punctuation">,</span> streamRecordSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EvictingWindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                windowAssigner<span class="token punctuation">,</span>
                windowAssigner<span class="token punctuation">.</span><span class="token function">getWindowSerializer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
                keySelector<span class="token punctuation">,</span>
                keyType<span class="token punctuation">.</span><span class="token function">createSerializer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
                stateDesc<span class="token punctuation">,</span>
                function<span class="token punctuation">,</span>
                trigger<span class="token punctuation">,</span>
                evictor<span class="token punctuation">,</span>
                allowedLateness<span class="token punctuation">,</span>
                lateDataOutputTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>通过构造的EvictingWindowOperator中的procesElement对每一个元素进行处理，调用emitWidnowContentes时会在使用InernalWindowFunction计算结果之前或之后调用Evictor的evictorBefore和evictorAfter。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EvictingWindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">WindowOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> IN<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> elementWindows <span class="token operator">=</span>
                windowAssigner<span class="token punctuation">.</span><span class="token function">assignWindows</span><span class="token punctuation">(</span>
                        element<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> windowAssignerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// if element is handled by none of assigned elementWindows</span>
        <span class="token keyword">boolean</span> isSkippedElement <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    
        <span class="token keyword">final</span> <span class="token class-name">K</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span><span class="token function">getKeyedStateBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowAssigner <span class="token keyword">instanceof</span> <span class="token class-name">MergingWindowAssigner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">/* ... */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">W</span> window <span class="token operator">:</span> elementWindows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
                <span class="token comment">// check if the window is already inactive</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isWindowLate</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                isSkippedElement <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
                evictingWindowState<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
                evictingWindowState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                triggerContext<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
                triggerContext<span class="token punctuation">.</span>window <span class="token operator">=</span> window<span class="token punctuation">;</span>
                evictorContext<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
                evictorContext<span class="token punctuation">.</span>window <span class="token operator">=</span> window<span class="token punctuation">;</span>
    
                <span class="token class-name">TriggerResult</span> triggerResult <span class="token operator">=</span> triggerContext<span class="token punctuation">.</span><span class="token function">onElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerResult<span class="token punctuation">.</span><span class="token function">isFire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> contents <span class="token operator">=</span> evictingWindowState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>contents <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// if we have no state, there is nothing to do</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 使用InternalWindowFunction对窗口的内容进行处理</span>
                    <span class="token function">emitWindowContents</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> contents<span class="token punctuation">,</span> evictingWindowState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    
                <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerResult<span class="token punctuation">.</span><span class="token function">isPurge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    evictingWindowState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">registerCleanupTimer</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// side output input event if</span>
        <span class="token comment">// element not handled by any window</span>
        <span class="token comment">// late arriving tag has been set</span>
        <span class="token comment">// windowAssigner is event time and current timestamp + allowed lateness no less than</span>
        <span class="token comment">// element timestamp</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSkippedElement <span class="token operator">&amp;&amp;</span> <span class="token function">isElementLate</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lateDataOutputTag <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sideOutput</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>numLateRecordsDropped<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">emitWindowContents</span><span class="token punctuation">(</span>
            <span class="token class-name">W</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> contents<span class="token punctuation">,</span> <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> windowState<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        timestampedCollector<span class="token punctuation">.</span><span class="token function">setAbsoluteTimestamp</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">maxTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// Work around type system restrictions...</span>
        <span class="token class-name">FluentIterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimestampedValue</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> recordsWithTimestamp <span class="token operator">=</span>
                <span class="token class-name">FluentIterable</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
                                <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">TimestampedValue</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">public</span> <span class="token class-name">TimestampedValue</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token keyword">return</span> <span class="token class-name">TimestampedValue</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用InternalWindowFunction之前</span>
        evictorContext<span class="token punctuation">.</span><span class="token function">evictBefore</span><span class="token punctuation">(</span>recordsWithTimestamp<span class="token punctuation">,</span> <span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>recordsWithTimestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token class-name">FluentIterable</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> projectedContents <span class="token operator">=</span>
                recordsWithTimestamp<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimestampedValue</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">,</span> IN<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token class-name">IN</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">TimestampedValue</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        processContext<span class="token punctuation">.</span>window <span class="token operator">=</span> triggerContext<span class="token punctuation">.</span>window<span class="token punctuation">;</span>
        <span class="token comment">// 调用InternalWindowFunction计算结果</span>
        userFunction<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
                triggerContext<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
                triggerContext<span class="token punctuation">.</span>window<span class="token punctuation">,</span>
                processContext<span class="token punctuation">,</span>
                projectedContents<span class="token punctuation">,</span>
                timestampedCollector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用InternalWindowFunction之后</span>
        evictorContext<span class="token punctuation">.</span><span class="token function">evictAfter</span><span class="token punctuation">(</span>recordsWithTimestamp<span class="token punctuation">,</span> <span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>recordsWithTimestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// work around to fix FLINK-4369, remove the evicted elements from the windowState.</span>
        <span class="token comment">// this is inefficient, but there is no other way to remove elements from ListState, which</span>
        <span class="token comment">// is an AppendingState.</span>
        windowState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TimestampedValue</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> recordsWithTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            windowState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getStreamRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br></div></div><h4 id="_9-allwindowedstream"><a href="#_9-allwindowedstream" class="header-anchor">#</a> 9. AllWindowedStream</h4> <p>前面我们看的是Keyed Window的具体实现，它是在KeyedStream之后进行调用的，所以所有的消息都会按照key进行分流。还有一种Non-Keyed Window，同样也可以进行窗口操作，通过windowAll调用得到AllWindowedStream。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllWindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AllWindowedStream</span><span class="token punctuation">(</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">WindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">&gt;</span></span> windowAssigner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>input <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NullByteKeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>windowAssigner <span class="token operator">=</span> windowAssigner<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>trigger <span class="token operator">=</span> windowAssigner<span class="token punctuation">.</span><span class="token function">getDefaultTrigger</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NullByteKeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Byte</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">614256539098549020L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Byte</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>从上面可以很明显的看出来，Non-Keyed Window就是Keyed Window的一种特殊实现。WindowStream中是在keyBy之后调用的，也就是输入的stream是KeyedStream，而相对比AllWindowStream，输入的流是DataStream，对输入的DataStream，在其构造方法内调用keyBy传入NullByteKeySelector的实现，也就是不分区，全部写入0分区。这样的结果会导致最终的所有数据全部由一个task处理，最终task的瓶颈也就是整个作业的瓶颈。</p> <h4 id="_10-总结"><a href="#_10-总结" class="header-anchor">#</a> 10. 总结</h4> <p>该篇文章从Keyed Window和Non-Keyed Window开始，分析了窗口的内部实现，以及在窗口中有着不可替代作用的Trigger和Timer。在最后也从窗口的计算方面从内部查看了全量窗口ProcessWindowFunction以及增量窗口AggregatingFunction的实现的具体区别，也从源码角度彻底了解了Keyed Window和Non-Keyed Window的区别。</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Flink" title="标签">#Flink</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/c5dabf/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">《从0学习Flink源码》——State</div></a> <a href="/pages/78d1d9/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">深入理解Java虚拟机</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/c5dabf/" class="prev">《从0学习Flink源码》——State</a></span> <span class="next"><a href="/pages/78d1d9/">深入理解Java虚拟机</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/78d1d9/"><div>
            深入理解Java虚拟机
            <!----></div></a> <span class="date">07-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/19ee33/"><div>
            Flink中的多流转换
            <!----></div></a> <span class="date">07-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/81a0f9/"><div>
            Flink中Time和Window
            <!----></div></a> <span class="date">07-11</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:yangqi199808@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Yanko24" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/weixin_43495317?spm=1000.2115.3001.5343" title="CSDN" target="_blank" class="iconfont icon-csdn"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>从零学习大数据</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.69860091.js" defer></script><script src="/assets/js/2.5a5d1011.js" defer></script><script src="/assets/js/255.c420fc14.js" defer></script>
  </body>
</html>
